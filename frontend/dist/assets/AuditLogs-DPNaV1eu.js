import{_ as p,u as m}from"./index-BxkOZnhC.js";import{b as d,p as e,t as a,x as c,y as h,A as f,s as y,C as L,F as v,D as w,g,f as u,z as C}from"./vendor-CFHPe_rb.js";const b={name:"AuditLogs",setup(){return{authStore:m()}},data(){return{pageName:"Audit Logs Dashboard",logs:[],filteredLogs:[],searchQuery:"",dateFrom:"",dateTo:"",actionFilter:"",loading:!1,clearing:!1,error:null,retryCount:0}},computed:{todayLogs(){const s=new Date().toISOString().split("T")[0];return this.filteredLogs.filter(t=>t.timestamp&&t.timestamp.startsWith(s)).length},weekLogs(){const s=new Date;s.setDate(s.getDate()-7);const t=s.toISOString().split("T")[0];return this.filteredLogs.filter(l=>l.timestamp&&l.timestamp>=t).length}},mounted(){this.initializeComponent()},methods:{initializeComponent(){if(!this.authStore.isAuthenticated){this.error="Please log in to access audit logs.";return}if(!this.authStore.isAdmin){this.error="You do not have permission to access this page.";return}this.fetchLogs()},async fetchLogs(s=!1){this.loading=!0,this.error=null;try{console.log("Fetching audit logs... (retry:",s,")");const t=await g.get("/api/admin/audit-logs");this.logs=t.data.data||t.data||[],this.filteredLogs=[...this.logs]}catch(t){console.error("Fetch error:",t),this.handleApiError(t)}finally{this.loading=!1}},filterLogs(){let s=[...this.logs];if(this.searchQuery){const t=this.searchQuery.toLowerCase();s=s.filter(l=>{var n;return((n=l.user_name)==null?void 0:n.toLowerCase().includes(t))||l.action.toLowerCase().includes(t)||l.details.toLowerCase().includes(t)})}this.dateFrom&&(s=s.filter(t=>t.timestamp&&t.timestamp>=this.dateFrom)),this.dateTo&&(s=s.filter(t=>t.timestamp&&t.timestamp<=this.dateTo)),this.actionFilter&&(s=s.filter(t=>t.action.toLowerCase()===this.actionFilter)),this.filteredLogs=s},async clearLogs(){if(confirm("Are you sure you want to clear all audit logs? This action cannot be undone.")){this.clearing=!0;try{await g.delete("/api/admin/audit-logs"),this.logs=[],this.filteredLogs=[],this.$notify({type:"success",title:"Success",text:"Audit logs cleared successfully!"})}catch(s){this.handleApiError(s)}finally{this.clearing=!1}}},async exportLogs(){try{const s=await g.get("/api/admin/audit-logs/export",{responseType:"blob"}),t=window.URL.createObjectURL(new Blob([s.data])),l=document.createElement("a");l.href=t,l.setAttribute("download",`audit-logs-${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(t),this.$notify({type:"success",title:"Success",text:"Audit logs exported successfully!"})}catch(s){this.handleApiError(s)}},viewDetails(s){this.$notify({type:"info",title:"Log Details",text:`User: ${s.user_name||"System"}
Action: ${s.action}
Timestamp: ${s.timestamp}
Details: ${s.details}`})},formatAction(s){return{create:"Create",update:"Update",delete:"Delete",login:"Login"}[s.toLowerCase()]||s},formatDate(s){return new Date(s).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},retryFetch(){this.retryCount++,this.retryCount<=3?this.fetchLogs(!0):this.error="Max retries exceeded. Check your network or server."},handleApiError(s){var l,n,r,i;let t="An unexpected error occurred.";s.code==="ERR_NETWORK"||s.message.includes("Network Error")?t="Network/CORS error: Ensure backend allows this origin.":((l=s.response)==null?void 0:l.status)===401?(t="Your session has expired. Please log in again.",this.authStore.clearAuth(),this.$router.push({name:"login"})):((n=s.response)==null?void 0:n.status)===403?t="You do not have permission to perform this action.":t=((i=(r=s.response)==null?void 0:r.data)==null?void 0:i.message)||t,this.error=t,this.$notify({type:"error",title:"Error",text:t})}}},A={class:"audit-logs-view"},S={class:"header"},k={class:"title"},x={class:"header-actions"},D=["disabled"],_={class:"filters"},T={class:"filter-group"},F={class:"filter-group"},U={class:"filter-group"},E={class:"summary-cards"},N={class:"card"},R={class:"value"},V={class:"card"},O={class:"value"},I={class:"card"},Q={class:"value"},z={class:"content"},B={key:0,class:"empty-state"},M={key:1,class:"audit-table"},W={class:"details-cell"},Y=["onClick"],j={key:2,class:"loading-overlay"};function P(s,t,l,n,r,i){return u(),d("div",A,[e("header",S,[e("h1",k,a(r.pageName),1),e("div",x,[e("button",{onClick:t[0]||(t[0]=(...o)=>i.clearLogs&&i.clearLogs(...o)),class:"clear-btn",disabled:r.clearing},"Clear All Logs",8,D),e("button",{onClick:t[1]||(t[1]=(...o)=>i.exportLogs&&i.exportLogs(...o)),class:"export-btn"},"ðŸ“¥ Export CSV")])]),e("div",_,[e("div",T,[t[10]||(t[10]=e("label",null,"Search:",-1)),c(e("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>r.searchQuery=o),onInput:t[3]||(t[3]=(...o)=>i.filterLogs&&i.filterLogs(...o)),placeholder:"Search by user, action, or details...",class:"search-input"},null,544),[[h,r.searchQuery]])]),e("div",F,[t[11]||(t[11]=e("label",null,"Date Range:",-1)),c(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>r.dateFrom=o),type:"date",onChange:t[5]||(t[5]=(...o)=>i.filterLogs&&i.filterLogs(...o))},null,544),[[h,r.dateFrom]]),c(e("input",{"onUpdate:modelValue":t[6]||(t[6]=o=>r.dateTo=o),type:"date",onChange:t[7]||(t[7]=(...o)=>i.filterLogs&&i.filterLogs(...o))},null,544),[[h,r.dateTo]])]),e("div",U,[t[13]||(t[13]=e("label",null,"Action:",-1)),c(e("select",{"onUpdate:modelValue":t[8]||(t[8]=o=>r.actionFilter=o),onChange:t[9]||(t[9]=(...o)=>i.filterLogs&&i.filterLogs(...o))},[...t[12]||(t[12]=[y('<option value="" data-v-d0533f37>All Actions</option><option value="create" data-v-d0533f37>Create</option><option value="update" data-v-d0533f37>Update</option><option value="delete" data-v-d0533f37>Delete</option><option value="login" data-v-d0533f37>Login</option>',5)])],544),[[f,r.actionFilter]])])]),e("div",E,[e("div",N,[t[14]||(t[14]=e("h3",null,"Total Logs",-1)),e("p",R,a(r.filteredLogs.length),1)]),e("div",V,[t[15]||(t[15]=e("h3",null,"Today",-1)),e("p",O,a(i.todayLogs),1)]),e("div",I,[t[16]||(t[16]=e("h3",null,"This Week",-1)),e("p",Q,a(i.weekLogs),1)])]),e("div",z,[r.logs.length===0&&!r.loading?(u(),d("div",B,[...t[17]||(t[17]=[e("p",null,"No audit logs yet.",-1)])])):(u(),d("table",M,[t[18]||(t[18]=e("thead",null,[e("tr",null,[e("th",null,"ID"),e("th",null,"User"),e("th",null,"Action"),e("th",null,"Timestamp"),e("th",null,"Details"),e("th",null,"Actions")])],-1)),e("tbody",null,[(u(!0),d(v,null,w(r.filteredLogs,o=>(u(),d("tr",{key:o.id},[e("td",null,a(o.id),1),e("td",null,a(o.user_name||"System"),1),e("td",null,[e("span",{class:C(["action-badge",o.action.toLowerCase()])},a(i.formatAction(o.action)),3)]),e("td",null,a(i.formatDate(o.timestamp)),1),e("td",W,a(o.details),1),e("td",null,[e("button",{onClick:q=>i.viewDetails(o),class:"action-btn view"},"View",8,Y)])]))),128))])])),r.loading?(u(),d("div",j,[...t[19]||(t[19]=[e("div",{class:"spinner"},null,-1),e("p",null,"Loading audit logs...",-1)])])):L("",!0)])])}const H=p(b,[["render",P],["__scopeId","data-v-d0533f37"]]);export{H as default};
