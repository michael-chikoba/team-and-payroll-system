import{b as d,C as h,p as s,z as p,t as i,x as k,y as M,q as T,F as _,D as v,A,g,f as c}from"./vendor-CFHPe_rb.js";import{_ as I}from"./index-BxkOZnhC.js";const E={name:"AttendanceMonitor",data(){return{attendanceData:[],departmentStats:[],departments:[],selectedDepartment:"all",loading:!1,error:null,retryCount:0,selectedDate:new Date().toISOString().split("T")[0],today:new Date().toISOString().split("T")[0],filterStatus:"all",markingPresentId:null,modalVisible:!1,modalTitle:"",modalMessage:"",modalIsConfirm:!1,modalIsSuccess:!1,modalIsError:!1,modalButtonText:"Close",modalResolve:null,modalReject:null,currentEmployeeToMark:null}},computed:{isToday(){return this.selectedDate===this.today},departmentFilteredData(){return this.selectedDepartment==="all"?this.attendanceData:this.attendanceData.filter(t=>t.department===this.selectedDepartment)},allCount(){return this.departmentFilteredData.length},presentCount(){return this.departmentFilteredData.filter(t=>["present","completed"].includes(t.status)).length},absentCount(){return this.departmentFilteredData.filter(t=>["absent","on_leave"].includes(t.status)).length},lateCount(){return this.departmentFilteredData.filter(t=>t.status==="late").length},currentOverview(){const t=this.departmentFilteredData,e=t.length,r=t.filter(l=>["present","completed"].includes(l.status)).length,o=t.filter(l=>l.status==="late").length,a=e-(r+o);return{totalEmployees:e,presentCount:r,absentCount:a,lateCount:o,attendanceRate:e>0?Math.round((r+o)/e*100):0}},filteredData(){let t=this.departmentFilteredData;return this.filterStatus==="all"?t:t.filter(e=>this.filterStatus==="present"?["present","completed"].includes(e.status):this.filterStatus==="absent"?["absent","on_leave"].includes(e.status):this.filterStatus==="late"?e.status==="late":e.status===this.filterStatus)}},mounted(){this.fetchAllData()},methods:{onDepartmentChange(){this.filterStatus="all"},showAlert(t,e="Notification",r="info"){return this.modalTitle=e,this.modalMessage=t,this.modalIsConfirm=!1,this.modalIsSuccess=r==="success",this.modalIsError=r==="error",this.modalButtonText="Close",this.modalVisible=!0,new Promise(o=>{this.modalResolve=o})},showConfirm(t,e="Confirmation"){return this.modalTitle=e,this.modalMessage=t,this.modalIsConfirm=!0,this.modalIsSuccess=!1,this.modalIsError=!1,this.modalButtonText="Confirm",this.modalVisible=!0,new Promise((r,o)=>{this.modalResolve=r,this.modalReject=o})},showSuccess(t,e="Success!"){return this.showAlert(t,e,"success")},showError(t,e="Error"){return this.showAlert(t,e,"error")},confirmAction(){this.modalVisible=!1,this.modalResolve&&this.modalResolve(!0),this.resetModal()},cancelAction(){this.modalVisible=!1,this.modalReject&&this.modalReject(!1),this.resetModal()},resetModal(){this.modalResolve=null,this.modalReject=null,this.modalTitle="",this.modalMessage="",this.modalIsConfirm=!1,this.modalIsSuccess=!1,this.modalIsError=!1,this.modalButtonText="Close",this.currentEmployeeToMark=null},async fetchAllData(){this.loading=!0,this.error=null;try{const[t,e]=await Promise.all([g.get("/api/admin/employees"),g.get("/api/admin/reports/attendance",{params:{date:this.selectedDate,detailed:!0}})]);await this.processAttendanceData(e.data,t.data)}catch(t){console.error("âŒ Fetch all data error:",t),this.handleApiError(t)}finally{this.loading=!1}},async processAttendanceData(t,e){const r=e.data||e.employees||e||[],o=t.data||t.attendances||t||[];this.departments=[...new Set(r.map(u=>u.department||"Unassigned"))].sort();const a=new Date(this.selectedDate).toISOString().split("T")[0],l=o.filter(u=>u.date?new Date(u.date).toISOString().split("T")[0]===a:!1),n=new Map;l.forEach(u=>{var f;const m=u.employee_id||((f=u.employee)==null?void 0:f.id);m&&n.set(m,u)}),this.attendanceData=r.map(u=>{const m=n.get(u.id)||null,f=(m==null?void 0:m.employee)||u,D=this.getEmployeeFullName(f),w=f.employee_id||`EMP${String(u.id).padStart(4,"0")}`,y=f.department||u.department||"Unassigned",C=f.position||u.position||"N/A",S=m?this.calculateHoursWorked(m.clock_in,m.clock_out):0;let b="absent";return m&&(b=m.status||"absent"),{id:u.id,full_name:D,employee_id:w,department:y,position:C,status:b,clock_in_time:m?m.clock_in:null,clock_out_time:m?m.clock_out:null,hours_worked:S,date:this.selectedDate}}),this.calculateDepartmentStats(r)},calculateHoursWorked(t,e){if(!t||!e)return 0;try{let r,o;if(t.includes("T")||t.includes("Z")?(r=new Date(t),o=new Date(e)):(r=new Date(`2000-01-01T${t}`),o=new Date(`2000-01-01T${e}`)),isNaN(r.getTime())||isNaN(o.getTime()))return 0;const l=(o-r)/(1e3*60*60);return Math.max(0,Math.round(l*100)/100)}catch(r){return console.warn("Error calculating hours worked:",r),0}},getEmployeeFullName(t){return t?t.first_name&&t.last_name?`${t.first_name} ${t.last_name}`.trim():t.full_name?t.full_name:t.name?t.name:"Unknown Employee":"Unknown Employee"},calculateDepartmentStats(t){const e=new Map;this.departments.forEach(r=>{e.set(r,{name:r,total:0,present:0,absent:0,late:0,rate:0})}),t.forEach(r=>{const o=r.department||"Unassigned";e.has(o)&&e.get(o).total++}),this.attendanceData.forEach(r=>{const o=r.department;if(e.has(o)){const a=e.get(o);["present","completed"].includes(r.status)?a.present++:r.status==="late"?a.late++:["absent","on_leave"].includes(r.status)&&a.absent++}}),e.forEach(r=>{if(r.total>0){const o=r.present+r.late;r.rate=Math.round(o/r.total*100)}}),this.departmentStats=Array.from(e.values())},retryFetch(){this.retryCount++,this.retryCount<=3?this.fetchAllData():(this.error="Max retries exceeded. Please refresh the page.",this.retryCount=0)},handleApiError(t){var r;let e="Failed to load attendance data.";if(t.response)if(t.response.status===401)e="Session expired. Please log in again.";else if(t.response.status===403)e="Access denied. You must be an admin to view this data.";else if(t.response.status===404){e="No attendance data found for this date.",this.resetData();return}else(r=t.response.data)!=null&&r.message&&(e=t.response.data.message);else t.request&&(e="Network error. Please check your connection.");this.error=e},resetData(){this.attendanceData=[],this.departmentStats=[]},async attemptMarkPresent(t){this.currentEmployeeToMark=t,await this.showConfirm(`Mark ${t.full_name} as present for ${this.safeFormatDate(this.selectedDate)}? This will register a manual clock-in.`,"Mark Employee Present").catch(()=>!1)&&await this.markPresent(t)},async markPresent(t){var e,r;this.markingPresentId=t.id;try{const o=await g.post(`/api/admin/attendance/${t.id}/mark-present`,{date:this.selectedDate,force:!0});console.log("âœ… Mark present response:",o.data),await this.showSuccess(`${t.full_name} has been successfully marked as present for ${this.safeFormatDate(this.selectedDate)}.`,"Success!"),await this.fetchAllData()}catch(o){console.error("âŒ Mark present error:",o);const a=((r=(e=o.response)==null?void 0:e.data)==null?void 0:r.message)||"Failed to mark employee as present. Please try again.";await this.showError(a,"Failed to Mark Present")}finally{this.markingPresentId=null}},viewHistory(t){this.showAlert(`Attendance history for ${t.full_name} would open in a real app.`,"View History")},getInitials(t){var a,l;if(!t||t==="Unknown Employee")return"??";const e=t.split(" ").filter(n=>n.length>0),r=((a=e[0])==null?void 0:a[0])||"",o=e.length>1?(l=e[e.length-1])==null?void 0:l[0]:"";return(r+o).toUpperCase().substring(0,2)},safeFormatDate(t){if(!t)return"N/A";try{const e=new Date(t);return isNaN(e.getTime())?"Invalid Date":e.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",weekday:"short"})}catch{return"Invalid Date"}},safeFormatTime(t){if(!t)return"N/A";if(t.match(/AM|PM/i))return t;try{let e;return t.includes("T")||t.includes("Z")?e=new Date(t):e=new Date(`2000-01-01T${t}`),isNaN(e.getTime())?t:e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}catch{return t}},formatHours(t){if(t==null||t===void 0||isNaN(t))return"0h 0m";const e=Math.floor(t),r=Math.round((t-e)*60);return`${e}h ${r}m`},formatStatus(t){return{present:"Present",completed:"Completed",absent:"Absent",late:"Late",on_leave:"On Leave"}[t]||t||"Unknown"},getStatusClass(t){return t==="completed"?"status-present":`status-${t}`}}},F={class:"attendance-monitor"},P={class:"simple-modal-content"},N={key:0,class:"modal-icon"},R={key:0},x={key:1},O={class:"modal-actions"},V={class:"page-header"},U={class:"subtitle"},L={class:"header-actions"},H=["max"],B=["disabled"],j={key:0},W={key:1},q={key:1,class:"loading"},z={key:2,class:"error-message"},Z={key:3},Y={key:0,class:"department-overview"},G={class:"department-cards"},J={class:"department-header"},K={class:"dept-count"},Q={class:"dept-metrics"},X={class:"dept-metric present"},$={class:"dept-value"},ee={class:"dept-metric absent"},te={class:"dept-value"},se={class:"dept-metric late"},ae={class:"dept-value"},ne={class:"dept-metric rate"},le={class:"dept-value"},re={key:1,class:"overview-section"},ie={class:"overview-card"},oe={class:"overview-metrics"},de={class:"metric total"},ce={class:"metric-value"},ue={class:"metric present"},me={class:"metric-value"},he={class:"metric absent"},fe={class:"metric-value"},pe={class:"metric late"},_e={class:"metric-value"},ve={class:"metric rate"},ge={class:"metric-value"},be={class:"employees-section"},ke={class:"section-header"},De={key:0,class:"department-filter"},we=["value"],ye={key:0,class:"filter-tabs"},Ce={class:"employees-grid"},Se={class:"employee-header"},Me={class:"employee-avatar"},Te={class:"employee-info"},Ae={class:"employee-id"},Ie={class:"employee-position"},Ee={class:"attendance-status"},Fe={class:"attendance-details"},Pe={class:"detail-row"},Ne={class:"value"},Re={class:"detail-row"},xe={class:"value"},Oe={class:"detail-row"},Ve={class:"value"},Ue={class:"detail-row"},Le={class:"value"},He={class:"attendance-actions"},Be=["onClick"],je=["onClick","disabled"],We={key:0,class:"loading-dots"},qe={key:1},ze={key:0,class:"empty-state"},Ze={key:0};function Ye(t,e,r,o,a,l){return c(),d("div",F,[a.modalVisible?(c(),d("div",{key:0,class:p(["simple-modal-overlay",{"is-confirm":a.modalIsConfirm,"is-success":a.modalIsSuccess,"is-error":a.modalIsError}])},[s("div",P,[a.modalIsSuccess||a.modalIsError?(c(),d("div",N,[a.modalIsSuccess?(c(),d("span",R,"âœ…")):a.modalIsError?(c(),d("span",x,"âŒ")):h("",!0)])):h("",!0),s("h3",null,i(a.modalTitle),1),s("p",null,i(a.modalMessage),1),s("div",O,[a.modalIsConfirm?(c(),d("button",{key:0,onClick:e[0]||(e[0]=(...n)=>l.cancelAction&&l.cancelAction(...n)),class:"btn-cancel"},"Cancel")):h("",!0),s("button",{onClick:e[1]||(e[1]=(...n)=>l.confirmAction&&l.confirmAction(...n)),class:p(["btn-primary",{"btn-success":a.modalIsSuccess,"btn-error":a.modalIsError}])},i(a.modalButtonText),3)])])],2)):h("",!0),s("div",V,[s("div",null,[e[12]||(e[12]=s("h1",null,"Team Attendance Monitor",-1)),s("p",U,"Monitoring team attendance for "+i(l.safeFormatDate(a.selectedDate)),1)]),s("div",L,[k(s("input",{type:"date","onUpdate:modelValue":e[2]||(e[2]=n=>a.selectedDate=n),onChange:e[3]||(e[3]=(...n)=>l.fetchAllData&&l.fetchAllData(...n)),max:a.today,class:"date-picker"},null,40,H),[[M,a.selectedDate]]),s("button",{onClick:e[4]||(e[4]=(...n)=>l.fetchAllData&&l.fetchAllData(...n)),class:"btn-refresh",disabled:a.loading},[a.loading?(c(),d("span",j,"Loading...")):(c(),d("span",W,"ðŸ”„ Refresh"))],8,B)])]),a.loading?(c(),d("div",q,[...e[13]||(e[13]=[s("div",{class:"spinner"},null,-1),s("p",null,"Loading attendance data...",-1)])])):a.error?(c(),d("div",z,[T(i(a.error)+" ",1),s("button",{onClick:e[5]||(e[5]=(...n)=>l.retryFetch&&l.retryFetch(...n)),class:"btn-primary"},"Retry")])):(c(),d("div",Z,[a.departmentStats.length>0?(c(),d("div",Y,[e[18]||(e[18]=s("h2",null,"ðŸ“Š Department Overview",-1)),s("div",G,[(c(!0),d(_,null,v(a.departmentStats,n=>(c(),d("div",{key:n.name,class:"department-card"},[s("div",J,[s("h3",null,i(n.name),1),s("span",K,i(n.total)+" employees",1)]),s("div",Q,[s("div",X,[s("span",$,i(n.present),1),e[14]||(e[14]=s("span",{class:"dept-label"},"Present",-1))]),s("div",ee,[s("span",te,i(n.absent),1),e[15]||(e[15]=s("span",{class:"dept-label"},"Absent",-1))]),s("div",se,[s("span",ae,i(n.late),1),e[16]||(e[16]=s("span",{class:"dept-label"},"Late",-1))]),s("div",ne,[s("span",le,i(n.rate)+"%",1),e[17]||(e[17]=s("span",{class:"dept-label"},"Rate",-1))])])]))),128))])])):h("",!0),l.currentOverview?(c(),d("div",re,[s("div",ie,[s("h3",null,"ðŸ“Š "+i(a.selectedDepartment==="all"?"Team":a.selectedDepartment)+" Attendance Overview",1),s("div",oe,[s("div",de,[s("span",ce,i(l.currentOverview.totalEmployees),1),e[19]||(e[19]=s("span",{class:"metric-label"},"Total Team Members",-1))]),s("div",ue,[s("span",me,i(l.currentOverview.presentCount),1),e[20]||(e[20]=s("span",{class:"metric-label"},"Present",-1))]),s("div",he,[s("span",fe,i(l.currentOverview.absentCount),1),e[21]||(e[21]=s("span",{class:"metric-label"},"Absent",-1))]),s("div",pe,[s("span",_e,i(l.currentOverview.lateCount),1),e[22]||(e[22]=s("span",{class:"metric-label"},"Late",-1))]),s("div",ve,[s("span",ge,i(l.currentOverview.attendanceRate)+"%",1),e[23]||(e[23]=s("span",{class:"metric-label"},"Attendance Rate",-1))])])])])):h("",!0),s("div",be,[s("div",ke,[s("h2",null,"Team Members ("+i(l.allCount)+")",1),a.departments.length>0?(c(),d("div",De,[k(s("select",{"onUpdate:modelValue":e[6]||(e[6]=n=>a.selectedDepartment=n),onChange:e[7]||(e[7]=(...n)=>l.onDepartmentChange&&l.onDepartmentChange(...n)),class:"dept-select"},[e[24]||(e[24]=s("option",{value:"all"},"All Departments",-1)),(c(!0),d(_,null,v(a.departments,n=>(c(),d("option",{key:n,value:n},i(n),9,we))),128))],544),[[A,a.selectedDepartment]])])):h("",!0)]),a.attendanceData.length>0?(c(),d("div",ye,[s("button",{onClick:e[8]||(e[8]=n=>a.filterStatus="all"),class:p([{active:a.filterStatus==="all"},"tab-btn"])}," All ("+i(l.allCount)+") ",3),s("button",{onClick:e[9]||(e[9]=n=>a.filterStatus="present"),class:p([{active:a.filterStatus==="present"},"tab-btn"])}," Present ("+i(l.presentCount)+") ",3),s("button",{onClick:e[10]||(e[10]=n=>a.filterStatus="absent"),class:p([{active:a.filterStatus==="absent"},"tab-btn"])}," Absent ("+i(l.absentCount)+") ",3),s("button",{onClick:e[11]||(e[11]=n=>a.filterStatus="late"),class:p([{active:a.filterStatus==="late"},"tab-btn"])}," Late ("+i(l.lateCount)+") ",3)])):h("",!0),s("div",Ce,[(c(!0),d(_,null,v(l.filteredData,n=>(c(),d("div",{key:n.id,class:"employee-card"},[s("div",Se,[s("div",Me,i(l.getInitials(n.full_name)),1),s("div",Te,[s("h3",null,i(n.full_name),1),s("p",Ae,i(n.employee_id)+" â€¢ "+i(n.department),1),s("p",Ie,i(n.position),1)]),s("div",Ee,[s("span",{class:p(["status-badge",l.getStatusClass(n.status)])},i(l.formatStatus(n.status)),3)])]),s("div",Fe,[s("div",Pe,[e[25]||(e[25]=s("span",{class:"label"},"ðŸ• Clock In:",-1)),s("span",Ne,i(l.safeFormatTime(n.clock_in_time)),1)]),s("div",Re,[e[26]||(e[26]=s("span",{class:"label"},"ðŸ• Clock Out:",-1)),s("span",xe,i(l.safeFormatTime(n.clock_out_time)),1)]),s("div",Oe,[e[27]||(e[27]=s("span",{class:"label"},"â±ï¸ Hours Worked:",-1)),s("span",Ve,i(l.formatHours(n.hours_worked)),1)]),s("div",Ue,[e[28]||(e[28]=s("span",{class:"label"},"ðŸ“… Date:",-1)),s("span",Le,i(l.safeFormatDate(n.date)),1)])]),s("div",He,[s("button",{onClick:u=>l.viewHistory(n),class:"btn-view"}," ðŸ“‹ View History ",8,Be),n.status==="absent"&&l.isToday?(c(),d("button",{key:0,onClick:u=>l.attemptMarkPresent(n),class:"btn-mark",disabled:a.markingPresentId===n.id},[a.markingPresentId===n.id?(c(),d("span",We,"Marking")):(c(),d("span",qe,"âœ“ Mark Present"))],8,je)):h("",!0)])]))),128)),l.filteredData.length===0?(c(),d("div",ze,[e[29]||(e[29]=s("div",{class:"empty-icon"},"ðŸ“­",-1)),s("p",null,"No "+i(a.filterStatus==="all"?"":l.formatStatus(a.filterStatus).toLowerCase())+" employees found",1),a.filterStatus!=="all"||a.selectedDepartment!=="all"?(c(),d("p",Ze,"Try changing the filter or date")):h("",!0)])):h("",!0)])])]))])}const Ke=I(E,[["render",Ye],["__scopeId","data-v-ec802a03"]]);export{Ke as default};
