import{_ as P,u as C}from"./index-cgHGa_Rg.js";import{b as c,p as e,t as i,C as p,z as m,q as F,x as y,y as f,A as b,s as S,F as k,D as v,g as h,f as u}from"./vendor-CFHPe_rb.js";const w={name:"Attendance",setup(){return{authStore:C()}},data(){return{pageName:"My Attendance",attendance:[],dateFrom:"",dateTo:"",statusFilter:"",today:new Date().toISOString().split("T")[0],todayStatus:"absent",stats:{totalHours:0,attendanceRate:0,lateDays:0,workdays:0},loading:!1,clockingIn:!1,clockingOut:!1,resetting:!1,showResetButton:!1,error:null,retryCount:0,currentPage:1,itemsPerPage:25}},computed:{filteredAttendance(){let s=[...this.attendance];return this.dateFrom&&(s=s.filter(t=>t.date>=this.dateFrom)),this.dateTo&&(s=s.filter(t=>t.date<=this.dateTo)),this.statusFilter&&(s=s.filter(t=>t.status===this.statusFilter)),s.sort((t,r)=>new Date(r.date)-new Date(t.date))},totalPages(){return Math.ceil(this.filteredAttendance.length/this.itemsPerPage)},paginatedRecords(){const s=(this.currentPage-1)*this.itemsPerPage,t=s+this.itemsPerPage;return this.filteredAttendance.slice(s,t)},visiblePages(){const s=[];let r=Math.max(1,this.currentPage-Math.floor(2.5)),l=Math.min(this.totalPages,r+5-1);l-r<4&&(r=Math.max(1,l-5+1));for(let a=r;a<=l;a++)s.push(a);return s}},mounted(){this.fetchAttendance(),this.fetchTodayStatus()},methods:{goToPage(s){s>=1&&s<=this.totalPages&&(this.currentPage=s)},handlePerPageChange(){this.currentPage=1},handleFilterChange(){this.currentPage=1,this.fetchAttendance()},async fetchAttendance(s=!1){this.loading=!0,this.error=null;try{const t={...this.dateFrom&&{from:this.dateFrom},...this.dateTo&&{to:this.dateTo},...this.statusFilter&&{status:this.statusFilter}},[r,l]=await Promise.all([h.get("/api/employee/attendance",{params:t}),h.get("/api/employee/attendance/stats")]);this.attendance=r.data.data||r.data||[];const a=l.data.stats||l.data||{};this.stats={totalHours:a.totalHours||a.total_hours||0,attendanceRate:a.attendanceRate||a.attendance_rate||0,lateDays:a.lateDays||a.late_days||0,workdays:a.workdays||a.working_days||0}}catch(t){this.handleApiError(t)}finally{this.loading=!1}},async fetchTodayStatus(){var s;try{const t=await h.get("/api/employee/attendance/today-status");this.todayStatus=t.data.status||"absent",this.todayStatus==="present"&&((s=t.data.attendance)!=null&&s.clockOut)&&(this.showResetButton=!0)}catch(t){console.error("Failed to fetch today status:",t),this.todayStatus="absent"}},async clockIn(){var s,t,r,l,a,n;this.clockingIn=!0;try{const d=await h.post("/api/employee/attendance/clock-in");this.todayStatus="present",this.showResetButton=!1,this.$notify({type:"success",title:"Success",text:d.data.message||"Clocked in successfully!"}),await this.fetchAttendance(),await this.fetchTodayStatus()}catch(d){console.error("Clock-in error:",d),((s=d.response)==null?void 0:s.status)===422&&((l=(r=(t=d.response)==null?void 0:t.data)==null?void 0:r.message)!=null&&l.includes("Already clocked in"))&&(this.showResetButton=!0),this.$notify({type:"error",title:"Clock-in Failed",text:((n=(a=d.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to clock in. Please try again."})}finally{this.clockingIn=!1}},async clockOut(){var s,t;this.clockingOut=!0;try{const r=await h.post("/api/employee/attendance/clock-out");this.todayStatus="completed",this.showResetButton=!1,this.$notify({type:"success",title:"Success",text:r.data.message||"Clocked out successfully!"}),await this.fetchAttendance(),await this.fetchTodayStatus()}catch(r){console.error("Clock-out error:",r),this.$notify({type:"error",title:"Clock-out Failed",text:((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.message)||"Failed to clock out. Please try again."})}finally{this.clockingOut=!1}},async forceResetStatus(){var s,t;if(confirm("This will auto-close any open attendance records. Continue?")){this.resetting=!0;try{const r=await h.post("/api/employee/attendance/force-reset");this.showResetButton=!1,this.$notify({type:"success",title:"Status Reset",text:r.data.message||"Attendance status has been reset successfully."}),await this.fetchTodayStatus(),await this.fetchAttendance()}catch(r){console.error("Reset error:",r),this.$notify({type:"error",title:"Reset Failed",text:((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.message)||"Failed to reset status. Please contact support."})}finally{this.resetting=!1}}},async exportAttendance(){try{const s={...this.dateFrom&&{from:this.dateFrom},...this.dateTo&&{to:this.dateTo},...this.statusFilter&&{status:this.statusFilter}},t=await h.get("/api/employee/attendance/export",{params:s,responseType:"blob"}),r=window.URL.createObjectURL(new Blob([t.data])),l=document.createElement("a");l.href=r,l.setAttribute("download",`attendance-${this.dateFrom||""}-${this.dateTo||this.today}.csv`),document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(r),this.$notify({type:"success",title:"Success",text:"Attendance exported successfully!"})}catch(s){this.handleApiError(s)}},resetFilters(){this.dateFrom="",this.dateTo="",this.statusFilter="",this.currentPage=1,this.fetchAttendance()},retryFetch(){this.retryCount++,this.retryCount<=3?this.fetchAttendance(!0):this.error="Max retries exceeded. Please refresh the page."},handleApiError(s){var r,l,a,n,d,g;let t="An unexpected error occurred.";s.code==="ERR_NETWORK"||(r=s.message)!=null&&r.includes("Network Error")?t="Network error. Check your connection.":((l=s.response)==null?void 0:l.status)===401?(t="Session expired. Redirecting to login...",this.authStore.clearAuth(),this.$router.push({name:"login"})):((a=s.response)==null?void 0:a.status)===403?t="Access denied.":((n=s.response)==null?void 0:n.status)===422?t=s.response.data.message||"Please check your input.":t=((g=(d=s.response)==null?void 0:d.data)==null?void 0:g.message)||t,this.error=t},getStatusClass(s){return s?s.toLowerCase():"present"},formatTodayStatus(s){return s?{present:"In Progress",completed:"Completed",absent:"Absent"}[s]||s:"Absent"},formatStatus(s){return s?{present:"Present",absent:"Absent",late:"Late",early_leave:"Early Leave"}[s]||s:"Present"},formatHours(s){if(!s&&s!==0)return"N/A";const t=Math.floor(s),r=Math.round(s%1*60);return`${t}h ${r}m`},formatTimeDisplay(s){if(!s)return"N/A";try{let t=s;if(t.includes("T")){const r=new Date(t),l=r.getHours(),a=r.getMinutes(),n=l>=12?"PM":"AM";return`${l%12||12}:${a.toString().padStart(2,"0")} ${n}`}if(t.includes(":")){const r=t.split(":"),l=parseInt(r[0]),a=parseInt(r[1]),n=l>=12?"PM":"AM";return`${l%12||12}:${a.toString().padStart(2,"0")} ${n}`}return s}catch(t){return console.error("Error formatting time:",t,s),s}},formatDate(s){if(!s)return"N/A";try{return new Date(s).toLocaleDateString("en-ZM",{year:"numeric",month:"short",day:"numeric",weekday:"short"})}catch{return s}}}},A={class:"attendance-view"},x={class:"header"},_={class:"header-left"},R={class:"title"},T={class:"header-right"},D={class:"clock-buttons"},M=["disabled"],I=["disabled"],O=["disabled"],N={class:"filters-section"},L={class:"filters-container"},H={class:"filter-group"},V=["max"],E={class:"filter-group"},B=["max"],U={class:"filter-group"},W={class:"filter-actions"},j={class:"content"},z={key:0,class:"summary-cards"},q={class:"card"},K={class:"card-value"},Z={class:"card"},G={class:"card-value"},J={class:"card"},Q={class:"card-value"},X={class:"card"},Y={class:"card-value"},$={class:"table-container"},tt={class:"table-header"},et={class:"table-info"},st={class:"record-count"},at={class:"page-info"},nt={key:0,class:"empty-state"},ot={key:1,class:"table-wrapper"},rt={class:"attendance-table"},lt={class:"date-cell"},it={class:"date-main"},dt={class:"time-cell"},ct={class:"time-cell"},ut={class:"hours-cell"},ht={class:"notes-cell"},gt={class:"pagination"},pt=["disabled"],yt=["disabled"],mt={class:"pagination-numbers"},ft=["onClick"],bt=["disabled"],kt=["disabled"],vt={key:1,class:"loading"},Pt={key:2,class:"error-message"};function Ct(s,t,r,l,a,n){var d,g;return u(),c("div",A,[e("header",x,[e("div",_,[e("h1",R,i(a.pageName),1),t[19]||(t[19]=e("p",{class:"subtitle"},"Track your daily attendance and work hours",-1))]),e("div",T,[e("div",D,[e("button",{onClick:t[0]||(t[0]=(...o)=>n.clockIn&&n.clockIn(...o)),disabled:a.todayStatus==="present"||a.todayStatus==="completed"||a.clockingIn,class:"clock-btn in"},i(a.clockingIn?"Clocking In...":"Clock In"),9,M),e("button",{onClick:t[1]||(t[1]=(...o)=>n.clockOut&&n.clockOut(...o)),disabled:a.todayStatus!=="present"||a.clockingOut,class:"clock-btn out"},i(a.clockingOut?"Clocking Out...":"Clock Out"),9,I),a.showResetButton?(u(),c("button",{key:0,onClick:t[2]||(t[2]=(...o)=>n.forceResetStatus&&n.forceResetStatus(...o)),disabled:a.resetting,class:"clock-btn reset",title:"Reset stuck attendance status"},i(a.resetting?"Resetting...":"Reset"),9,O)):p("",!0)]),e("div",{class:m(["status-badge",a.todayStatus?a.todayStatus.toLowerCase():"absent"])},[t[20]||(t[20]=e("span",{class:"status-dot"},null,-1)),F(" "+i(n.formatTodayStatus(a.todayStatus)),1)],2)])]),e("div",N,[e("div",L,[e("div",H,[t[21]||(t[21]=e("label",null,"From Date",-1)),y(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>a.dateFrom=o),type:"date",onChange:t[4]||(t[4]=(...o)=>n.handleFilterChange&&n.handleFilterChange(...o)),max:a.today},null,40,V),[[f,a.dateFrom]])]),e("div",E,[t[22]||(t[22]=e("label",null,"To Date",-1)),y(e("input",{"onUpdate:modelValue":t[5]||(t[5]=o=>a.dateTo=o),type:"date",onChange:t[6]||(t[6]=(...o)=>n.handleFilterChange&&n.handleFilterChange(...o)),max:a.today},null,40,B),[[f,a.dateTo]])]),e("div",U,[t[24]||(t[24]=e("label",null,"Status",-1)),y(e("select",{"onUpdate:modelValue":t[7]||(t[7]=o=>a.statusFilter=o),onChange:t[8]||(t[8]=(...o)=>n.handleFilterChange&&n.handleFilterChange(...o))},[...t[23]||(t[23]=[S('<option value="" data-v-7778e011>All Statuses</option><option value="present" data-v-7778e011>Present</option><option value="absent" data-v-7778e011>Absent</option><option value="late" data-v-7778e011>Late</option><option value="early_leave" data-v-7778e011>Early Leave</option>',5)])],544),[[b,a.statusFilter]])]),e("div",W,[e("button",{onClick:t[9]||(t[9]=(...o)=>n.resetFilters&&n.resetFilters(...o)),class:"btn-secondary"}," Reset "),e("button",{onClick:t[10]||(t[10]=(...o)=>n.exportAttendance&&n.exportAttendance(...o)),class:"btn-export"}," Export ")])])]),e("div",j,[a.loading?p("",!0):(u(),c("div",z,[e("div",q,[t[25]||(t[25]=e("div",{class:"card-header"},[e("div",{class:"card-icon blue"}),e("span",{class:"card-label"},"Total Hours")],-1)),e("p",K,i(((d=a.stats.totalHours)==null?void 0:d.toFixed(1))||0),1),t[26]||(t[26]=e("p",{class:"card-unit"},"hours this month",-1))]),e("div",Z,[t[27]||(t[27]=e("div",{class:"card-header"},[e("div",{class:"card-icon green"}),e("span",{class:"card-label"},"Attendance Rate")],-1)),e("p",G,i(((g=a.stats.attendanceRate)==null?void 0:g.toFixed(1))||0)+"%",1),t[28]||(t[28]=e("p",{class:"card-unit"},"of workdays",-1))]),e("div",J,[t[29]||(t[29]=e("div",{class:"card-header"},[e("div",{class:"card-icon orange"}),e("span",{class:"card-label"},"Late Days")],-1)),e("p",Q,i(a.stats.lateDays||0),1),t[30]||(t[30]=e("p",{class:"card-unit"},"this month",-1))]),e("div",X,[t[31]||(t[31]=e("div",{class:"card-header"},[e("div",{class:"card-icon purple"}),e("span",{class:"card-label"},"Workdays")],-1)),e("p",Y,i(a.stats.workdays||0),1),t[32]||(t[32]=e("p",{class:"card-unit"},"this month",-1))])])),e("div",$,[e("div",tt,[t[33]||(t[33]=e("h2",null,"Attendance Records",-1)),e("div",et,[e("span",st,i(n.filteredAttendance.length)+" records",1),e("span",at,"Page "+i(a.currentPage)+" of "+i(n.totalPages),1)])]),n.filteredAttendance.length===0&&!a.loading?(u(),c("div",nt,[t[34]||(t[34]=e("div",{class:"empty-icon"},null,-1)),t[35]||(t[35]=e("h3",null,"No Records Found",-1)),t[36]||(t[36]=e("p",null,"No attendance records match your current filters.",-1)),e("button",{onClick:t[11]||(t[11]=(...o)=>n.resetFilters&&n.resetFilters(...o)),class:"btn-primary"},"Reset Filters")])):a.loading?p("",!0):(u(),c("div",ot,[e("table",rt,[t[37]||(t[37]=e("thead",null,[e("tr",null,[e("th",null,"Date"),e("th",null,"Check In"),e("th",null,"Check Out"),e("th",null,"Hours Worked"),e("th",null,"Status"),e("th",null,"Notes")])],-1)),e("tbody",null,[(u(!0),c(k,null,v(n.paginatedRecords,o=>(u(),c("tr",{key:o.id,class:"table-row"},[e("td",null,[e("div",lt,[e("span",it,i(n.formatDate(o.date)),1)])]),e("td",null,[e("div",dt,i(n.formatTimeDisplay(o.checkIn||o.clock_in)),1)]),e("td",null,[e("div",ct,i(n.formatTimeDisplay(o.checkOut||o.clock_out)),1)]),e("td",null,[e("div",ut,i(n.formatHours(o.hoursWorked||o.total_hours)),1)]),e("td",null,[e("span",{class:m(["status-badge-table",n.getStatusClass(o.status)])},i(n.formatStatus(o.status)),3)]),e("td",null,[e("span",ht,i(o.notes||"-"),1)])]))),128))])]),e("div",gt,[e("button",{onClick:t[12]||(t[12]=o=>n.goToPage(1)),disabled:a.currentPage===1,class:"pagination-btn prev-first"}," First ",8,pt),e("button",{onClick:t[13]||(t[13]=o=>n.goToPage(a.currentPage-1)),disabled:a.currentPage===1,class:"pagination-btn prev"}," Previous ",8,yt),e("div",mt,[(u(!0),c(k,null,v(n.visiblePages,o=>(u(),c("button",{key:o,onClick:Ft=>n.goToPage(o),class:m(["pagination-number",{active:o===a.currentPage}])},i(o),11,ft))),128))]),e("button",{onClick:t[14]||(t[14]=o=>n.goToPage(a.currentPage+1)),disabled:a.currentPage===n.totalPages,class:"pagination-btn next"}," Next ",8,bt),e("button",{onClick:t[15]||(t[15]=o=>n.goToPage(n.totalPages)),disabled:a.currentPage===n.totalPages,class:"pagination-btn next-last"}," Last ",8,kt),y(e("select",{"onUpdate:modelValue":t[16]||(t[16]=o=>a.itemsPerPage=o),onChange:t[17]||(t[17]=(...o)=>n.handlePerPageChange&&n.handlePerPageChange(...o)),class:"per-page-select"},[...t[38]||(t[38]=[e("option",{value:10},"10 per page",-1),e("option",{value:25},"25 per page",-1),e("option",{value:50},"50 per page",-1),e("option",{value:100},"100 per page",-1)])],544),[[b,a.itemsPerPage]])])]))]),a.loading?(u(),c("div",vt,[...t[39]||(t[39]=[e("div",{class:"spinner"},null,-1),e("p",null,"Loading attendance records...",-1)])])):p("",!0),a.error?(u(),c("div",Pt,[t[40]||(t[40]=e("div",{class:"error-icon"},null,-1)),e("p",null,i(a.error),1),e("button",{onClick:t[18]||(t[18]=(...o)=>n.retryFetch&&n.retryFetch(...o)),class:"btn-primary"},"Retry")])):p("",!0)])])}const At=P(w,[["render",Ct],["__scopeId","data-v-7778e011"]]);export{At as default};
