import{_ as g,u as b}from"./index-C1X9tsoG.js";import{b as c,p as s,t as i,C as p,z as m,x as f,y as k,A as S,s as v,F as A,D as w,q as F,g as h,f as u}from"./vendor-Dn_KV7fh.js";const C={name:"Attendance",setup(){return{authStore:b()}},data(){return{pageName:"My Attendance",attendance:[],dateFrom:"",dateTo:"",statusFilter:"",today:new Date().toISOString().split("T")[0],todayStatus:"absent",stats:{totalHours:0,attendanceRate:0,lateDays:0,workdays:0},loading:!1,clockingIn:!1,clockingOut:!1,resetting:!1,showResetButton:!1,error:null,retryCount:0}},computed:{filteredAttendance(){let e=[...this.attendance];return this.dateFrom&&(e=e.filter(t=>t.date>=this.dateFrom)),this.dateTo&&(e=e.filter(t=>t.date<=this.dateTo)),this.statusFilter&&(e=e.filter(t=>t.status===this.statusFilter)),e.sort((t,r)=>new Date(r.date)-new Date(t.date))}},mounted(){this.fetchAttendance(),this.fetchTodayStatus()},methods:{async fetchAttendance(e=!1){this.loading=!0,this.error=null;try{const t={...this.dateFrom&&{from:this.dateFrom},...this.dateTo&&{to:this.dateTo},...this.statusFilter&&{status:this.statusFilter}},[r,l]=await Promise.all([h.get("/api/employee/attendance",{params:t}),h.get("/api/employee/attendance/stats")]);this.attendance=r.data.data||r.data||[];const a=l.data.stats||l.data||{};this.stats={totalHours:a.totalHours||a.total_hours||0,attendanceRate:a.attendanceRate||a.attendance_rate||0,lateDays:a.lateDays||a.late_days||0,workdays:a.workdays||a.working_days||0}}catch(t){this.handleApiError(t)}finally{this.loading=!1}},async fetchTodayStatus(){var e;try{const t=await h.get("/api/employee/attendance/today-status");this.todayStatus=t.data.status||"absent",this.todayStatus==="present"&&((e=t.data.attendance)!=null&&e.clockOut)&&(this.showResetButton=!0)}catch(t){console.error("Failed to fetch today status:",t),this.todayStatus="absent"}},async clockIn(){var e,t,r,l,a,n;this.clockingIn=!0;try{const d=await h.post("/api/employee/attendance/clock-in");this.todayStatus="present",this.showResetButton=!1,this.$notify({type:"success",title:"Success",text:d.data.message||"Clocked in successfully!"}),await this.fetchAttendance(),await this.fetchTodayStatus()}catch(d){console.error("Clock-in error:",d),((e=d.response)==null?void 0:e.status)===422&&((l=(r=(t=d.response)==null?void 0:t.data)==null?void 0:r.message)!=null&&l.includes("Already clocked in"))&&(this.showResetButton=!0),this.$notify({type:"error",title:"Clock-in Failed",text:((n=(a=d.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to clock in. Please try again."})}finally{this.clockingIn=!1}},async clockOut(){var e,t;this.clockingOut=!0;try{const r=await h.post("/api/employee/attendance/clock-out");this.todayStatus="completed",this.showResetButton=!1,this.$notify({type:"success",title:"Success",text:r.data.message||"Clocked out successfully!"}),await this.fetchAttendance(),await this.fetchTodayStatus()}catch(r){console.error("Clock-out error:",r),this.$notify({type:"error",title:"Clock-out Failed",text:((t=(e=r.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to clock out. Please try again."})}finally{this.clockingOut=!1}},async forceResetStatus(){var e,t;if(confirm("This will auto-close any open attendance records. Continue?")){this.resetting=!0;try{const r=await h.post("/api/employee/attendance/force-reset");this.showResetButton=!1,this.$notify({type:"success",title:"Status Reset",text:r.data.message||"Attendance status has been reset successfully."}),await this.fetchTodayStatus(),await this.fetchAttendance()}catch(r){console.error("Reset error:",r),this.$notify({type:"error",title:"Reset Failed",text:((t=(e=r.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to reset status. Please contact support."})}finally{this.resetting=!1}}},async exportAttendance(){try{const e={...this.dateFrom&&{from:this.dateFrom},...this.dateTo&&{to:this.dateTo},...this.statusFilter&&{status:this.statusFilter}},t=await h.get("/api/employee/attendance/export",{params:e,responseType:"blob"}),r=window.URL.createObjectURL(new Blob([t.data])),l=document.createElement("a");l.href=r,l.setAttribute("download",`attendance-${this.dateFrom||""}-${this.dateTo||this.today}.csv`),document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(r),this.$notify({type:"success",title:"Success",text:"Attendance exported successfully!"})}catch(e){this.handleApiError(e)}},resetFilters(){this.dateFrom="",this.dateTo="",this.statusFilter="",this.fetchAttendance()},retryFetch(){this.retryCount++,this.retryCount<=3?this.fetchAttendance(!0):this.error="Max retries exceeded. Please refresh the page."},handleApiError(e){var r,l,a,n,d,y;let t="An unexpected error occurred.";e.code==="ERR_NETWORK"||(r=e.message)!=null&&r.includes("Network Error")?t="Network error. Check your connection.":((l=e.response)==null?void 0:l.status)===401?(t="Session expired. Redirecting to login...",this.authStore.clearAuth(),this.$router.push({name:"login"})):((a=e.response)==null?void 0:a.status)===403?t="Access denied.":((n=e.response)==null?void 0:n.status)===422?t=e.response.data.message||"Please check your input.":t=((y=(d=e.response)==null?void 0:d.data)==null?void 0:y.message)||t,this.error=t},getStatusClass(e){return e?e.toLowerCase():"present"},formatTodayStatus(e){return e?{present:"In Progress",completed:"Completed",absent:"Absent"}[e]||e:"Absent"},formatStatus(e){return e?{present:"Present",absent:"Absent",late:"Late",early_leave:"Early Leave"}[e]||e:"Present"},formatHours(e){if(!e&&e!==0)return"N/A";const t=Math.floor(e),r=Math.round(e%1*60);return`${t}h ${r}m`},formatTimeDisplay(e){if(!e)return"N/A";try{let t=e;if(t.includes("T")){const r=new Date(t),l=r.getHours(),a=r.getMinutes(),n=l>=12?"PM":"AM";return`${l%12||12}:${a.toString().padStart(2,"0")} ${n}`}if(t.includes(":")){const r=t.split(":"),l=parseInt(r[0]),a=parseInt(r[1]),n=l>=12?"PM":"AM";return`${l%12||12}:${a.toString().padStart(2,"0")} ${n}`}return e}catch(t){return console.error("Error formatting time:",t,e),e}},formatDate(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("en-ZM",{year:"numeric",month:"short",day:"numeric",weekday:"short"})}catch{return e}}}},R={class:"attendance-view"},T={class:"header"},x={class:"header-left"},_={class:"title"},D={class:"header-right"},I={class:"clock-buttons"},O=["disabled"],M=["disabled"],L=["disabled"],N={class:"filters"},H={class:"filter-group"},E=["max"],P=["max"],B={class:"filter-group"},V={class:"content"},U={key:0,class:"summary-cards"},W={class:"card"},j={class:"value"},z={class:"card"},q={class:"value"},K={class:"card"},Z={class:"value"},G={class:"card"},J={class:"value"},Q={key:1,class:"empty-state"},X={key:2,class:"attendance-table"},Y={key:3,class:"loading"},$={key:4,class:"error-message"};function tt(e,t,r,l,a,n){var d,y;return u(),c("div",R,[s("header",T,[s("div",x,[s("h1",_,i(a.pageName),1),t[12]||(t[12]=s("p",{class:"subtitle"},"Track your daily attendance and work hours",-1))]),s("div",D,[s("div",I,[s("button",{onClick:t[0]||(t[0]=(...o)=>n.clockIn&&n.clockIn(...o)),disabled:a.todayStatus==="present"||a.todayStatus==="completed"||a.clockingIn,class:"clock-btn in"},i(a.clockingIn?"Clocking In...":"Clock In"),9,O),s("button",{onClick:t[1]||(t[1]=(...o)=>n.clockOut&&n.clockOut(...o)),disabled:a.todayStatus!=="present"||a.clockingOut,class:"clock-btn out"},i(a.clockingOut?"Clocking Out...":"Clock Out"),9,M),a.showResetButton?(u(),c("button",{key:0,onClick:t[2]||(t[2]=(...o)=>n.forceResetStatus&&n.forceResetStatus(...o)),disabled:a.resetting,class:"clock-btn reset",title:"Reset stuck attendance status"},i(a.resetting?"Resetting...":"ðŸ”„ Reset Status"),9,L)):p("",!0)]),s("span",{class:m(["today-status",a.todayStatus?a.todayStatus.toLowerCase():"absent"])}," Today: "+i(n.formatTodayStatus(a.todayStatus)),3)])]),s("div",N,[s("div",H,[t[13]||(t[13]=s("label",null,"Date Range:",-1)),f(s("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>a.dateFrom=o),type:"date",onChange:t[4]||(t[4]=(...o)=>n.fetchAttendance&&n.fetchAttendance(...o)),max:a.today},null,40,E),[[k,a.dateFrom]]),f(s("input",{"onUpdate:modelValue":t[5]||(t[5]=o=>a.dateTo=o),type:"date",onChange:t[6]||(t[6]=(...o)=>n.fetchAttendance&&n.fetchAttendance(...o)),max:a.today},null,40,P),[[k,a.dateTo]])]),s("div",B,[t[15]||(t[15]=s("label",null,"Status:",-1)),f(s("select",{"onUpdate:modelValue":t[7]||(t[7]=o=>a.statusFilter=o),onChange:t[8]||(t[8]=(...o)=>n.fetchAttendance&&n.fetchAttendance(...o))},[...t[14]||(t[14]=[v('<option value="" data-v-b3827e56>All</option><option value="present" data-v-b3827e56>Present</option><option value="absent" data-v-b3827e56>Absent</option><option value="late" data-v-b3827e56>Late</option><option value="early_leave" data-v-b3827e56>Early Leave</option>',5)])],544),[[S,a.statusFilter]])]),s("button",{onClick:t[9]||(t[9]=(...o)=>n.exportAttendance&&n.exportAttendance(...o)),class:"export-btn"},"ðŸ“¥ Export CSV")]),s("div",V,[a.loading?p("",!0):(u(),c("div",U,[s("div",W,[t[16]||(t[16]=s("div",{class:"card-icon"},"ðŸ•",-1)),t[17]||(t[17]=s("h3",null,"Total Hours This Month",-1)),s("p",j,i(((d=a.stats.totalHours)==null?void 0:d.toFixed(1))||0)+" hrs",1)]),s("div",z,[t[18]||(t[18]=s("div",{class:"card-icon"},"ðŸ“Š",-1)),t[19]||(t[19]=s("h3",null,"Attendance Rate",-1)),s("p",q,i(((y=a.stats.attendanceRate)==null?void 0:y.toFixed(1))||0)+"%",1)]),s("div",K,[t[20]||(t[20]=s("div",{class:"card-icon"},"âš ï¸",-1)),t[21]||(t[21]=s("h3",null,"Late Days",-1)),s("p",Z,i(a.stats.lateDays||0),1)]),s("div",G,[t[22]||(t[22]=s("div",{class:"card-icon"},"ðŸ“…",-1)),t[23]||(t[23]=s("h3",null,"Workdays This Month",-1)),s("p",J,i(a.stats.workdays||0),1)])])),n.filteredAttendance.length===0&&!a.loading?(u(),c("div",Q,[t[24]||(t[24]=s("p",null,"No attendance records found for the selected date range.",-1)),s("button",{onClick:t[10]||(t[10]=(...o)=>n.resetFilters&&n.resetFilters(...o)),class:"btn-primary"},"Reset Filters")])):a.loading?p("",!0):(u(),c("table",X,[t[25]||(t[25]=s("thead",null,[s("tr",null,[s("th",null,"Date"),s("th",null,"Check In"),s("th",null,"Check Out"),s("th",null,"Hours Worked"),s("th",null,"Status"),s("th",null,"Notes")])],-1)),s("tbody",null,[(u(!0),c(A,null,w(n.filteredAttendance,o=>(u(),c("tr",{key:o.id},[s("td",null,i(n.formatDate(o.date)),1),s("td",null,i(n.formatTimeDisplay(o.checkIn||o.clock_in)),1),s("td",null,i(n.formatTimeDisplay(o.checkOut||o.clock_out)),1),s("td",null,i(n.formatHours(o.hoursWorked||o.total_hours)),1),s("td",null,[s("span",{class:m(["status",n.getStatusClass(o.status)])},i(n.formatStatus(o.status)),3)]),s("td",null,i(o.notes||"-"),1)]))),128))])])),a.loading?(u(),c("div",Y,[...t[26]||(t[26]=[s("div",{class:"spinner"},null,-1),s("p",null,"Loading attendance records...",-1)])])):p("",!0),a.error?(u(),c("div",$,[F(i(a.error)+" ",1),s("button",{onClick:t[11]||(t[11]=(...o)=>n.retryFetch&&n.retryFetch(...o)),class:"btn-primary"},"Retry")])):p("",!0)])])}const at=g(C,[["render",tt],["__scopeId","data-v-b3827e56"]]);export{at as default};
