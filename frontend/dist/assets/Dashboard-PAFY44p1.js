import{_ as L,u as w}from"./index-CUA5mSp8.js";import{b as c,p as t,C as S,t as d,F as M,D as C,a as f,w as _,e as I,g as m,f as u}from"./vendor-CFHPe_rb.js";const P={name:"ManagerDashboard",setup(){return{authStore:w()}},data(){return{overview:{teamSize:0,pendingLeaves:0,attendanceRate:0,totalHours:0},attendanceSummary:null,pendingLeaves:[],loading:!1,loadingAttendance:!1,error:null,debugInfo:null,retryCount:0,today:new Date().toISOString().split("T")[0],pollInterval:null,pollIntervalMs:3e4}},mounted(){this.initializeComponent()},beforeUnmount(){this.stopPolling()},methods:{initializeComponent(){if(console.log("=== Manager Dashboard Initialization ==="),console.log("Authenticated:",this.authStore.isAuthenticated),console.log("Is Manager:",this.authStore.isManager),console.log("User:",this.authStore.user),console.log("Token exists:",!!this.authStore.token),!this.authStore.isAuthenticated){this.error="Please log in to access the dashboard.";return}if(!this.authStore.isManager){this.error="You do not have permission to access this page.";return}this.fetchDashboardData(),this.startPolling()},startPolling(){this.pollInterval||(this.pollInterval=setInterval(()=>{this.refreshAttendance()},this.pollIntervalMs),console.log(`Started polling attendance every ${this.pollIntervalMs/1e3} seconds`))},stopPolling(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null,console.log("Stopped polling attendance"))},async fetchDashboardData(s=!1){var e,n,r,a,l,p,i,h,v;this.loading=!0,this.error=null,this.debugInfo=null;try{console.log("=== Fetching Manager Dashboard Data ==="),console.log("Retry attempt:",s?this.retryCount:"Initial"),console.log("Base URL:",m.defaults.baseURL),console.log("Auth token present:",!!this.authStore.token),console.log("User ID:",(e=this.authStore.user)==null?void 0:e.id),console.log("User role:",(n=this.authStore.user)==null?void 0:n.role);const[o,y]=await Promise.all([m.get("/api/dashboard"),m.get("/api/manager/attendance",{params:{date:this.today}})]);if(console.log("=== Dashboard Response ==="),console.log("Status:",o.status),console.log("Role:",o.data.role),console.log("=== Attendance Response ==="),console.log("Status:",y.status),console.log("Attendance data:",y.data),o.data.role!=="manager")throw new Error(`Expected manager role but got: ${o.data.role}`);const k=o.data.stats||{},D=k.team_productivity||{};let g=y.data.attendances||[];g=g.filter(R=>R.date===this.today);const b=(y.data.summary||{}).total_employees||0;console.log("ðŸ“Š Processing attendance data:",{teamSize:b,attendanceDataCount:g.length,rawAttendanceData:g});const A=this.calculateAttendanceMetrics(g,b);this.overview={teamSize:b,pendingLeaves:k.pending_leave_approvals||0,attendanceRate:A.attendanceRate,totalHours:Math.round(D.total_hours||0)},this.attendanceSummary=A.summary,this.pendingLeaves=o.data.pending_leaves||[],console.log("=== Data Mapped Successfully ==="),console.log("Overview:",this.overview),console.log("Attendance Summary:",this.attendanceSummary),console.log("Pending leaves count:",this.pendingLeaves.length),this.retryCount=0}catch(o){console.error("=== Dashboard Fetch Error ==="),console.error("Error type:",o.name),console.error("Error message:",o.message),console.error("Error code:",o.code),console.error("Response status:",(r=o.response)==null?void 0:r.status),console.error("Response data:",(a=o.response)==null?void 0:a.data),console.error("Full error:",o),this.debugInfo={errorType:o.name,errorMessage:o.message,errorCode:o.code,responseStatus:(l=o.response)==null?void 0:l.status,responseData:(p=o.response)==null?void 0:p.data,requestUrl:(i=o.config)==null?void 0:i.url,requestMethod:(h=o.config)==null?void 0:h.method,hasToken:!!this.authStore.token,userRole:(v=this.authStore.user)==null?void 0:v.role,baseURL:m.defaults.baseURL},this.handleApiError(o)}finally{this.loading=!1}},async refreshAttendance(){if(!this.loadingAttendance){this.loadingAttendance=!0;try{console.log("=== Refreshing Attendance Data ===");const s=await m.get("/api/manager/attendance",{params:{date:this.today}});let e=s.data.attendances||[];e=e.filter(l=>l.date===this.today);const r=(s.data.summary||{}).total_employees||0,a=this.calculateAttendanceMetrics(e,r);this.overview={...this.overview,teamSize:r,attendanceRate:a.attendanceRate},this.attendanceSummary=a.summary,console.log("=== Attendance Refreshed ==="),console.log("Updated Attendance Summary:",this.attendanceSummary)}catch(s){console.error("Attendance refresh error:",s)}finally{this.loadingAttendance=!1}}},calculateAttendanceMetrics(s,e){const n={present:0,absent:0,late:0,onLeave:0};if(!s||!Array.isArray(s))return e>0&&(n.absent=e),{summary:n,attendanceRate:0};let r=0;s.forEach(p=>{var h;switch(((h=p.status)==null?void 0:h.toLowerCase())||"absent"){case"present":case"completed":n.present++;break;case"late":n.late++;break;case"on_leave":n.onLeave++;break;case"absent":n.absent++;break;default:n.absent++}r++}),r<e&&(n.absent+=e-r);const a=n.present+n.late,l=e>0?Math.round(a/e*100):0;return console.log("ðŸ“Š Calculated Attendance Metrics:",{summary:n,presentAndLateCount:a,teamSize:e,attendanceRate:l}),{summary:n,attendanceRate:l}},retryFetch(){this.retryCount++,console.log("Retry attempt:",this.retryCount),this.retryCount<=3?this.fetchDashboardData(!0):this.error="Max retries exceeded. Please check your connection and try again later."},handleApiError(s){var n,r,a,l,p,i,h;let e="An unexpected error occurred.";if(s.code==="ERR_NETWORK"||s.message.includes("Network Error"))e="Network error: Cannot connect to the server. Please check if the backend is running.";else if(((n=s.response)==null?void 0:n.status)===401)e="Authentication failed. Your session may have expired. Please log in again.",setTimeout(()=>{this.authStore.clearAuth(),this.$router.push({name:"login"})},2e3);else if(((r=s.response)==null?void 0:r.status)===403)e="Access denied. You do not have permission to view this dashboard.";else if(((a=s.response)==null?void 0:a.status)===404){const v=(l=s.config)==null?void 0:l.url;v!=null&&v.includes("/api/manager/attendance")?e="Attendance endpoint not found. Please verify the API route exists: /api/manager/attendance":e="Dashboard endpoint not found. Please verify the API route exists: /api/dashboard"}else((p=s.response)==null?void 0:p.status)===500?e="Server error. Please contact support if this persists.":e=((h=(i=s.response)==null?void 0:i.data)==null?void 0:h.message)||s.message||e;this.error=e},async approveLeave(s){var e,n;try{await m.post(`/api/manager/leaves/${s}/approve`),alert("Leave approved successfully!"),this.fetchDashboardData()}catch(r){console.error("Approve leave error:",r),alert("Failed to approve leave: "+(((n=(e=r.response)==null?void 0:e.data)==null?void 0:n.message)||r.message))}},async rejectLeave(s){var n,r;const e=prompt("Please provide a reason for rejection:");if(e)try{await m.post(`/api/manager/leaves/${s}/reject`,{reason:e}),alert("Leave rejected."),this.fetchDashboardData()}catch(a){console.error("Reject leave error:",a),alert("Failed to reject leave: "+(((r=(n=a.response)==null?void 0:n.data)==null?void 0:r.message)||a.message))}},formatLeaveType(s){return s?s.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):"N/A"},formatDate(s){if(!s)return"N/A";try{return new Date(s.includes("T")?s:s+"T00:00:00").toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",weekday:"short"})}catch{return s}}}},T={class:"manager-dashboard"},E={key:0,class:"error-message"},x={key:1,class:"error-message"},U={key:2,class:"loading"},q={key:3,class:"error-message"},j={key:0,class:"error-details"},F={key:4,class:"dashboard-content"},N={class:"metrics-section"},B={class:"metrics-grid"},H={class:"metric-card"},O={class:"metric-value"},V={class:"metric-card"},Y={class:"metric-value"},z={class:"metric-card"},K={class:"metric-value"},Q={class:"metric-card"},W={class:"metric-value"},G={key:0,class:"attendance-summary-section"},J={class:"attendance-header"},X={class:"attendance-date"},Z=["disabled"],$={key:0},ee={key:1},te={class:"attendance-stats"},se={class:"attendance-stat present"},ae={class:"stat-value"},ne={class:"attendance-stat absent"},oe={class:"stat-value"},re={class:"attendance-stat late"},le={class:"stat-value"},ie={class:"attendance-stat leave"},de={class:"stat-value"},ce={class:"activities-section"},ue={key:0,class:"pending-leaves-list"},pe={class:"leave-header"},he={class:"employee-info"},ve={class:"employee-name"},me={class:"leave-type"},ge={class:"leave-dates"},ye={class:"leave-details"},fe={class:"leave-reason"},_e={class:"leave-days"},be={class:"leave-actions"},ke=["onClick"],Ae=["onClick"],Se={key:1,class:"empty-state"},De={class:"quick-links-section"},Re={class:"quick-links-grid"};function Le(s,e,n,r,a,l){const p=I("router-link");return u(),c("div",T,[e[26]||(e[26]=t("div",{class:"page-header"},[t("h1",null,"Manager Dashboard")],-1)),r.authStore.isAuthenticated?r.authStore.isManager?a.loading?(u(),c("div",U,[...e[2]||(e[2]=[t("div",{class:"spinner"},null,-1),t("p",null,"Loading dashboard...",-1)])])):a.error?(u(),c("div",q,[e[4]||(e[4]=t("h3",null,"Error Loading Dashboard",-1)),t("p",null,d(a.error),1),a.debugInfo?(u(),c("div",j,[t("details",null,[e[3]||(e[3]=t("summary",null,"Debug Information (click to expand)",-1)),t("pre",null,d(a.debugInfo),1)])])):S("",!0),t("button",{onClick:e[0]||(e[0]=(...i)=>l.retryFetch&&l.retryFetch(...i)),class:"btn-primary"},"Retry")])):(u(),c("div",F,[t("div",N,[e[13]||(e[13]=t("h2",null,"Team Metrics",-1)),t("div",B,[t("div",H,[e[5]||(e[5]=t("div",{class:"metric-icon"},"ðŸ‘¥",-1)),t("div",O,d(a.overview.teamSize),1),e[6]||(e[6]=t("div",{class:"metric-label"},"Team Members",-1))]),t("div",V,[e[7]||(e[7]=t("div",{class:"metric-icon"},"â°",-1)),t("div",Y,d(a.overview.pendingLeaves),1),e[8]||(e[8]=t("div",{class:"metric-label"},"Pending Leaves",-1))]),t("div",z,[e[9]||(e[9]=t("div",{class:"metric-icon"},"ðŸ“Š",-1)),t("div",K,d(a.overview.attendanceRate)+"%",1),e[10]||(e[10]=t("div",{class:"metric-label"},"Attendance Rate",-1))]),t("div",Q,[e[11]||(e[11]=t("div",{class:"metric-icon"},"â±ï¸",-1)),t("div",W,d(a.overview.totalHours),1),e[12]||(e[12]=t("div",{class:"metric-label"},"Total Team Hours",-1))])])]),a.attendanceSummary?(u(),c("div",G,[t("div",J,[e[14]||(e[14]=t("h2",null,"Today's Attendance",-1)),t("span",X,d(l.formatDate(a.today)),1),t("button",{onClick:e[1]||(e[1]=(...i)=>l.refreshAttendance&&l.refreshAttendance(...i)),class:"btn-refresh",disabled:a.loadingAttendance},[a.loadingAttendance?(u(),c("span",$,"ðŸ”„")):(u(),c("span",ee,"ðŸ”„ Refresh"))],8,Z)]),t("div",te,[t("div",se,[t("span",ae,d(a.attendanceSummary.present||0),1),e[15]||(e[15]=t("span",{class:"stat-label"},"Present",-1))]),t("div",ne,[t("span",oe,d(a.attendanceSummary.absent||0),1),e[16]||(e[16]=t("span",{class:"stat-label"},"Absent",-1))]),t("div",re,[t("span",le,d(a.attendanceSummary.late||0),1),e[17]||(e[17]=t("span",{class:"stat-label"},"Late",-1))]),t("div",ie,[t("span",de,d(a.attendanceSummary.onLeave||0),1),e[18]||(e[18]=t("span",{class:"stat-label"},"On Leave",-1))])])])):S("",!0),t("div",ce,[e[20]||(e[20]=t("h2",null,"Pending Leave Approvals",-1)),a.pendingLeaves.length>0?(u(),c("div",ue,[(u(!0),c(M,null,C(a.pendingLeaves,i=>{var h,v;return u(),c("div",{key:i.id,class:"leave-item"},[t("div",pe,[t("div",he,[t("span",ve,d(((v=(h=i.employee)==null?void 0:h.user)==null?void 0:v.name)||"Unknown Employee"),1),t("span",me,d(l.formatLeaveType(i.type)),1)]),t("span",ge,d(l.formatDate(i.start_date))+" - "+d(l.formatDate(i.end_date)),1)]),t("div",ye,[t("p",fe,d(i.reason||"No reason provided"),1),t("span",_e,d(i.number_of_days||0)+" days",1)]),t("div",be,[t("button",{onClick:o=>l.approveLeave(i.id),class:"btn-approve"},"âœ“ Approve",8,ke),t("button",{onClick:o=>l.rejectLeave(i.id),class:"btn-reject"},"âœ— Reject",8,Ae)])])}),128))])):(u(),c("div",Se,[...e[19]||(e[19]=[t("p",null,"âœ… No pending leave approvals",-1)])]))]),t("div",De,[e[25]||(e[25]=t("h2",null,"Quick Actions",-1)),t("div",Re,[f(p,{to:"/manager/employees",class:"quick-link-card"},{default:_(()=>[...e[21]||(e[21]=[t("div",{class:"quick-link-icon"},"ðŸ‘¨â€ðŸ’¼",-1),t("span",null,"View Team",-1)])]),_:1}),f(p,{to:"/manager/leave-approvals",class:"quick-link-card"},{default:_(()=>[...e[22]||(e[22]=[t("div",{class:"quick-link-icon"},"ðŸ“…",-1),t("span",null,"Leave Approvals",-1)])]),_:1}),f(p,{to:"/manager/attendance",class:"quick-link-card"},{default:_(()=>[...e[23]||(e[23]=[t("div",{class:"quick-link-icon"},"ðŸ“ˆ",-1),t("span",null,"Attendance Report",-1)])]),_:1}),f(p,{to:"/manager/reports/team",class:"quick-link-card"},{default:_(()=>[...e[24]||(e[24]=[t("div",{class:"quick-link-icon"},"ðŸ“‹",-1),t("span",null,"Team Reports",-1)])]),_:1})])])])):(u(),c("div",x," You don't have permission to access this page. ")):(u(),c("div",E," Please log in to access the dashboard. "))])}const Ie=L(P,[["render",Le],["__scopeId","data-v-d33e0a68"]]);export{Ie as default};
