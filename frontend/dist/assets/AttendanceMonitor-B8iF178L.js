import{b as d,s as h,p as s,z as p,t as i,x as k,y as M,q as T,F as v,C as _,A,g,f as c}from"./vendor-COruVTVJ.js";import{_ as I}from"./index-Djdf6BKf.js";const E={name:"AttendanceMonitor",data(){return{attendanceData:[],teamOverview:null,departmentStats:[],departments:[],selectedDepartment:"all",loading:!1,error:null,retryCount:0,selectedDate:new Date().toISOString().split("T")[0],today:new Date().toISOString().split("T")[0],filterStatus:"all",markingPresentId:null,modalVisible:!1,modalTitle:"",modalMessage:"",modalIsConfirm:!1,modalIsSuccess:!1,modalIsError:!1,modalButtonText:"Close",modalResolve:null,modalReject:null,currentEmployeeToMark:null}},computed:{isToday(){return this.selectedDate===this.today},presentCount(){return this.attendanceData.filter(t=>["present","completed"].includes(t.status)).length},absentCount(){return this.teamOverview?this.teamOverview.absentCount:0},lateCount(){return this.attendanceData.filter(t=>t.status==="late").length},filteredData(){let t=this.attendanceData;return this.selectedDepartment!=="all"&&(t=t.filter(e=>e.department===this.selectedDepartment)),this.filterStatus==="all"?t:t.filter(e=>this.filterStatus==="present"?["present","completed"].includes(e.status):this.filterStatus==="absent"?["absent","on_leave"].includes(e.status):this.filterStatus==="late"?e.status==="late":e.status===this.filterStatus)}},mounted(){this.fetchAllData()},methods:{showAlert(t,e="Notification",l="info"){return this.modalTitle=e,this.modalMessage=t,this.modalIsConfirm=!1,this.modalIsSuccess=l==="success",this.modalIsError=l==="error",this.modalButtonText="Close",this.modalVisible=!0,new Promise(o=>{this.modalResolve=o})},showConfirm(t,e="Confirmation"){return this.modalTitle=e,this.modalMessage=t,this.modalIsConfirm=!0,this.modalIsSuccess=!1,this.modalIsError=!1,this.modalButtonText="Confirm",this.modalVisible=!0,new Promise((l,o)=>{this.modalResolve=l,this.modalReject=o})},showSuccess(t,e="Success!"){return this.showAlert(t,e,"success")},showError(t,e="Error"){return this.showAlert(t,e,"error")},confirmAction(){this.modalVisible=!1,this.modalResolve&&this.modalResolve(!0),this.resetModal()},cancelAction(){this.modalVisible=!1,this.modalReject&&this.modalReject(!1),this.resetModal()},resetModal(){this.modalResolve=null,this.modalReject=null,this.modalTitle="",this.modalMessage="",this.modalIsConfirm=!1,this.modalIsSuccess=!1,this.modalIsError=!1,this.modalButtonText="Close",this.currentEmployeeToMark=null},async fetchAllData(){this.loading=!0,this.error=null;try{const[t,e]=await Promise.all([g.get("/api/admin/employees"),g.get("/api/admin/reports/attendance",{params:{date:this.selectedDate,detailed:!0}})]);await this.processAttendanceData(e.data,t.data)}catch(t){console.error("âŒ Fetch all data error:",t),this.handleApiError(t)}finally{this.loading=!1}},async processAttendanceData(t,e){const l=e.data||e.employees||e||[],o=t.data||t.attendances||t||[];this.departments=[...new Set(l.map(u=>u.department||"Unassigned"))].sort();const a=new Date(this.selectedDate).toISOString().split("T")[0],r=o.filter(u=>u.date?new Date(u.date).toISOString().split("T")[0]===a:!1),n=new Map;r.forEach(u=>{var f;const m=u.employee_id||((f=u.employee)==null?void 0:f.id);m&&n.set(m,u)}),this.attendanceData=l.map(u=>{const m=n.get(u.id)||null,f=(m==null?void 0:m.employee)||u,w=this.getEmployeeFullName(f),y=f.employee_id||`EMP${String(u.id).padStart(4,"0")}`,D=f.department||u.department||"Unassigned",C=f.position||u.position||"N/A",S=m?this.calculateHoursWorked(m.clock_in,m.clock_out):0;let b="absent";return m&&(b=m.status||"absent"),{id:u.id,full_name:w,employee_id:y,department:D,position:C,status:b,clock_in_time:m?m.clock_in:null,clock_out_time:m?m.clock_out:null,hours_worked:S,date:this.selectedDate}}),this.calculateDepartmentStats(l),this.calculateTeamOverview()},calculateHoursWorked(t,e){if(!t||!e)return 0;try{let l,o;if(t.includes("T")||t.includes("Z")?(l=new Date(t),o=new Date(e)):(l=new Date(`2000-01-01T${t}`),o=new Date(`2000-01-01T${e}`)),isNaN(l.getTime())||isNaN(o.getTime()))return 0;const r=(o-l)/(1e3*60*60);return Math.max(0,Math.round(r*100)/100)}catch(l){return console.warn("Error calculating hours worked:",l),0}},getEmployeeFullName(t){return t?t.first_name&&t.last_name?`${t.first_name} ${t.last_name}`.trim():t.full_name?t.full_name:t.name?t.name:"Unknown Employee":"Unknown Employee"},calculateDepartmentStats(t){const e=new Map;this.departments.forEach(l=>{e.set(l,{name:l,total:0,present:0,absent:0,late:0,rate:0})}),t.forEach(l=>{const o=l.department||"Unassigned";e.has(o)&&e.get(o).total++}),this.attendanceData.forEach(l=>{const o=l.department;if(e.has(o)){const a=e.get(o);["present","completed"].includes(l.status)?a.present++:l.status==="late"?a.late++:["absent","on_leave"].includes(l.status)&&a.absent++}}),e.forEach(l=>{if(l.total>0){const o=l.present+l.late;l.rate=Math.round(o/l.total*100)}}),this.departmentStats=Array.from(e.values())},calculateTeamOverview(){const t=this.attendanceData.length,e=this.attendanceData.filter(a=>["present","completed"].includes(a.status)).length,l=this.attendanceData.filter(a=>a.status==="late").length,o=t-(e+l);this.teamOverview={totalEmployees:t,presentCount:e,absentCount:o,lateCount:l,attendanceRate:t>0?Math.round((e+l)/t*100):0}},retryFetch(){this.retryCount++,this.retryCount<=3?this.fetchAllData():(this.error="Max retries exceeded. Please refresh the page.",this.retryCount=0)},handleApiError(t){var l;let e="Failed to load attendance data.";if(t.response)if(t.response.status===401)e="Session expired. Please log in again.";else if(t.response.status===403)e="Access denied. You must be an admin to view this data.";else if(t.response.status===404){e="No attendance data found for this date.",this.resetData();return}else(l=t.response.data)!=null&&l.message&&(e=t.response.data.message);else t.request&&(e="Network error. Please check your connection.");this.error=e},resetData(){this.attendanceData=[],this.teamOverview={totalEmployees:0,presentCount:0,absentCount:0,lateCount:0,attendanceRate:0},this.departmentStats=[]},async attemptMarkPresent(t){this.currentEmployeeToMark=t,await this.showConfirm(`Mark ${t.full_name} as present for ${this.safeFormatDate(this.selectedDate)}? This will register a manual clock-in.`,"Mark Employee Present").catch(()=>!1)&&await this.markPresent(t)},async markPresent(t){var e,l;this.markingPresentId=t.id;try{const o=await g.post(`/api/admin/attendance/${t.id}/mark-present`,{date:this.selectedDate,force:!0});console.log("âœ… Mark present response:",o.data),await this.showSuccess(`${t.full_name} has been successfully marked as present for ${this.safeFormatDate(this.selectedDate)}.`,"Success!"),await this.fetchAllData()}catch(o){console.error("âŒ Mark present error:",o);const a=((l=(e=o.response)==null?void 0:e.data)==null?void 0:l.message)||"Failed to mark employee as present. Please try again.";await this.showError(a,"Failed to Mark Present")}finally{this.markingPresentId=null}},viewHistory(t){this.showAlert(`Attendance history for ${t.full_name} would open in a real app.`,"View History")},getInitials(t){var a,r;if(!t||t==="Unknown Employee")return"??";const e=t.split(" ").filter(n=>n.length>0),l=((a=e[0])==null?void 0:a[0])||"",o=e.length>1?(r=e[e.length-1])==null?void 0:r[0]:"";return(l+o).toUpperCase().substring(0,2)},safeFormatDate(t){if(!t)return"N/A";try{const e=new Date(t);return isNaN(e.getTime())?"Invalid Date":e.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",weekday:"short"})}catch{return"Invalid Date"}},safeFormatTime(t){if(!t)return"N/A";if(t.match(/AM|PM/i))return t;try{let e;return t.includes("T")||t.includes("Z")?e=new Date(t):e=new Date(`2000-01-01T${t}`),isNaN(e.getTime())?t:e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}catch{return t}},formatHours(t){if(t==null||t===void 0||isNaN(t))return"0h 0m";const e=Math.floor(t),l=Math.round((t-e)*60);return`${e}h ${l}m`},formatStatus(t){return{present:"Present",completed:"Completed",absent:"Absent",late:"Late",on_leave:"On Leave"}[t]||t||"Unknown"},getStatusClass(t){return t==="completed"?"status-present":`status-${t}`}}},P={class:"attendance-monitor"},N={class:"simple-modal-content"},F={key:0,class:"modal-icon"},O={key:0},R={key:1},x={class:"modal-actions"},V={class:"page-header"},U={class:"subtitle"},L={class:"header-actions"},H=["max"],B=["disabled"],j={key:0},W={key:1},q={key:1,class:"loading"},z={key:2,class:"error-message"},Z={key:3},Y={key:0,class:"department-overview"},G={class:"department-cards"},J={class:"department-header"},K={class:"dept-count"},Q={class:"dept-metrics"},X={class:"dept-metric present"},$={class:"dept-value"},ee={class:"dept-metric absent"},te={class:"dept-value"},se={class:"dept-metric late"},ae={class:"dept-value"},ne={class:"dept-metric rate"},le={class:"dept-value"},re={key:1,class:"overview-section"},ie={class:"overview-card"},oe={class:"overview-metrics"},de={class:"metric total"},ce={class:"metric-value"},ue={class:"metric present"},me={class:"metric-value"},he={class:"metric absent"},fe={class:"metric-value"},pe={class:"metric late"},ve={class:"metric-value"},_e={class:"metric rate"},ge={class:"metric-value"},be={class:"employees-section"},ke={class:"section-header"},we={key:0,class:"department-filter"},ye=["value"],De={key:0,class:"filter-tabs"},Ce={class:"employees-grid"},Se={class:"employee-header"},Me={class:"employee-avatar"},Te={class:"employee-info"},Ae={class:"employee-id"},Ie={class:"employee-position"},Ee={class:"attendance-status"},Pe={class:"attendance-details"},Ne={class:"detail-row"},Fe={class:"value"},Oe={class:"detail-row"},Re={class:"value"},xe={class:"detail-row"},Ve={class:"value"},Ue={class:"detail-row"},Le={class:"value"},He={class:"attendance-actions"},Be=["onClick"],je=["onClick","disabled"],We={key:0,class:"loading-dots"},qe={key:1},ze={key:0,class:"empty-state"},Ze={key:0};function Ye(t,e,l,o,a,r){return c(),d("div",P,[a.modalVisible?(c(),d("div",{key:0,class:p(["simple-modal-overlay",{"is-confirm":a.modalIsConfirm,"is-success":a.modalIsSuccess,"is-error":a.modalIsError}])},[s("div",N,[a.modalIsSuccess||a.modalIsError?(c(),d("div",F,[a.modalIsSuccess?(c(),d("span",O,"âœ…")):a.modalIsError?(c(),d("span",R,"âŒ")):h("",!0)])):h("",!0),s("h3",null,i(a.modalTitle),1),s("p",null,i(a.modalMessage),1),s("div",x,[a.modalIsConfirm?(c(),d("button",{key:0,onClick:e[0]||(e[0]=(...n)=>r.cancelAction&&r.cancelAction(...n)),class:"btn-cancel"},"Cancel")):h("",!0),s("button",{onClick:e[1]||(e[1]=(...n)=>r.confirmAction&&r.confirmAction(...n)),class:p(["btn-primary",{"btn-success":a.modalIsSuccess,"btn-error":a.modalIsError}])},i(a.modalButtonText),3)])])],2)):h("",!0),s("div",V,[s("div",null,[e[11]||(e[11]=s("h1",null,"Team Attendance Monitor",-1)),s("p",U,"Monitoring team attendance for "+i(r.safeFormatDate(a.selectedDate)),1)]),s("div",L,[k(s("input",{type:"date","onUpdate:modelValue":e[2]||(e[2]=n=>a.selectedDate=n),onChange:e[3]||(e[3]=(...n)=>r.fetchAllData&&r.fetchAllData(...n)),max:a.today,class:"date-picker"},null,40,H),[[M,a.selectedDate]]),s("button",{onClick:e[4]||(e[4]=(...n)=>r.fetchAllData&&r.fetchAllData(...n)),class:"btn-refresh",disabled:a.loading},[a.loading?(c(),d("span",j,"Loading...")):(c(),d("span",W,"ðŸ”„ Refresh"))],8,B)])]),a.loading?(c(),d("div",q,[...e[12]||(e[12]=[s("div",{class:"spinner"},null,-1),s("p",null,"Loading attendance data...",-1)])])):a.error?(c(),d("div",z,[T(i(a.error)+" ",1),s("button",{onClick:e[5]||(e[5]=(...n)=>r.retryFetch&&r.retryFetch(...n)),class:"btn-primary"},"Retry")])):(c(),d("div",Z,[a.departmentStats.length>0?(c(),d("div",Y,[e[17]||(e[17]=s("h2",null,"ðŸ“Š Department Overview",-1)),s("div",G,[(c(!0),d(v,null,_(a.departmentStats,n=>(c(),d("div",{key:n.name,class:"department-card"},[s("div",J,[s("h3",null,i(n.name),1),s("span",K,i(n.total)+" employees",1)]),s("div",Q,[s("div",X,[s("span",$,i(n.present),1),e[13]||(e[13]=s("span",{class:"dept-label"},"Present",-1))]),s("div",ee,[s("span",te,i(n.absent),1),e[14]||(e[14]=s("span",{class:"dept-label"},"Absent",-1))]),s("div",se,[s("span",ae,i(n.late),1),e[15]||(e[15]=s("span",{class:"dept-label"},"Late",-1))]),s("div",ne,[s("span",le,i(n.rate)+"%",1),e[16]||(e[16]=s("span",{class:"dept-label"},"Rate",-1))])])]))),128))])])):h("",!0),a.teamOverview?(c(),d("div",re,[s("div",ie,[e[23]||(e[23]=s("h3",null,"ðŸ“Š Team Attendance Overview",-1)),s("div",oe,[s("div",de,[s("span",ce,i(a.teamOverview.totalEmployees),1),e[18]||(e[18]=s("span",{class:"metric-label"},"Total Team Members",-1))]),s("div",ue,[s("span",me,i(a.teamOverview.presentCount),1),e[19]||(e[19]=s("span",{class:"metric-label"},"Present",-1))]),s("div",he,[s("span",fe,i(a.teamOverview.absentCount),1),e[20]||(e[20]=s("span",{class:"metric-label"},"Absent",-1))]),s("div",pe,[s("span",ve,i(a.teamOverview.lateCount),1),e[21]||(e[21]=s("span",{class:"metric-label"},"Late",-1))]),s("div",_e,[s("span",ge,i(a.teamOverview.attendanceRate)+"%",1),e[22]||(e[22]=s("span",{class:"metric-label"},"Attendance Rate",-1))])])])])):h("",!0),s("div",be,[s("div",ke,[s("h2",null,"Team Members ("+i(a.attendanceData.length)+")",1),a.departments.length>0?(c(),d("div",we,[k(s("select",{"onUpdate:modelValue":e[6]||(e[6]=n=>a.selectedDepartment=n),class:"dept-select"},[e[24]||(e[24]=s("option",{value:"all"},"All Departments",-1)),(c(!0),d(v,null,_(a.departments,n=>(c(),d("option",{key:n,value:n},i(n),9,ye))),128))],512),[[A,a.selectedDepartment]])])):h("",!0)]),a.attendanceData.length>0?(c(),d("div",De,[s("button",{onClick:e[7]||(e[7]=n=>a.filterStatus="all"),class:p([{active:a.filterStatus==="all"},"tab-btn"])}," All ("+i(a.attendanceData.length)+") ",3),s("button",{onClick:e[8]||(e[8]=n=>a.filterStatus="present"),class:p([{active:a.filterStatus==="present"},"tab-btn"])}," Present ("+i(r.presentCount)+") ",3),s("button",{onClick:e[9]||(e[9]=n=>a.filterStatus="absent"),class:p([{active:a.filterStatus==="absent"},"tab-btn"])}," Absent ("+i(r.absentCount)+") ",3),s("button",{onClick:e[10]||(e[10]=n=>a.filterStatus="late"),class:p([{active:a.filterStatus==="late"},"tab-btn"])}," Late ("+i(r.lateCount)+") ",3)])):h("",!0),s("div",Ce,[(c(!0),d(v,null,_(r.filteredData,n=>(c(),d("div",{key:n.id,class:"employee-card"},[s("div",Se,[s("div",Me,i(r.getInitials(n.full_name)),1),s("div",Te,[s("h3",null,i(n.full_name),1),s("p",Ae,i(n.employee_id)+" â€¢ "+i(n.department),1),s("p",Ie,i(n.position),1)]),s("div",Ee,[s("span",{class:p(["status-badge",r.getStatusClass(n.status)])},i(r.formatStatus(n.status)),3)])]),s("div",Pe,[s("div",Ne,[e[25]||(e[25]=s("span",{class:"label"},"ðŸ• Clock In:",-1)),s("span",Fe,i(r.safeFormatTime(n.clock_in_time)),1)]),s("div",Oe,[e[26]||(e[26]=s("span",{class:"label"},"ðŸ• Clock Out:",-1)),s("span",Re,i(r.safeFormatTime(n.clock_out_time)),1)]),s("div",xe,[e[27]||(e[27]=s("span",{class:"label"},"â±ï¸ Hours Worked:",-1)),s("span",Ve,i(r.formatHours(n.hours_worked)),1)]),s("div",Ue,[e[28]||(e[28]=s("span",{class:"label"},"ðŸ“… Date:",-1)),s("span",Le,i(r.safeFormatDate(n.date)),1)])]),s("div",He,[s("button",{onClick:u=>r.viewHistory(n),class:"btn-view"}," ðŸ“‹ View History ",8,Be),n.status==="absent"&&r.isToday?(c(),d("button",{key:0,onClick:u=>r.attemptMarkPresent(n),class:"btn-mark",disabled:a.markingPresentId===n.id},[a.markingPresentId===n.id?(c(),d("span",We,"Marking")):(c(),d("span",qe,"âœ“ Mark Present"))],8,je)):h("",!0)])]))),128)),r.filteredData.length===0?(c(),d("div",ze,[e[29]||(e[29]=s("div",{class:"empty-icon"},"ðŸ“­",-1)),s("p",null,"No "+i(a.filterStatus==="all"?"":r.formatStatus(a.filterStatus).toLowerCase())+" employees found",1),a.filterStatus!=="all"||a.selectedDepartment!=="all"?(c(),d("p",Ze,"Try changing the filter or date")):h("",!0)])):h("",!0)])])]))])}const Ke=I(E,[["render",Ye],["__scopeId","data-v-b60e010e"]]);export{Ke as default};
