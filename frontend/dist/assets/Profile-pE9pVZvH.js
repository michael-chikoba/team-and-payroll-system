import{_ as b,u as v}from"./index-BxkOZnhC.js";import{b as a,p as s,t as p,C as c,q as y,v as _,x as u,y as m,z as P,F,D,g as f,f as d}from"./vendor-CFHPe_rb.js";const E={name:"Profile",setup(){return{authStore:v()}},data(){return{pageName:"My Profile",form:{first_name:"",last_name:"",email:"",phone:"",date_of_birth:"",national_id:"",address:"",emergency_contact:""},passwordForm:{current_password:"",password:"",password_confirmation:""},employeeInfo:null,profilePicUrl:"",documents:[],today:new Date().toISOString().split("T")[0],loading:!1,updatingProfile:!1,updatingPassword:!1,uploadingDoc:!1,formError:null,passwordError:null,successMessage:null,passwordSuccess:null,error:null,retryCount:0,originalFormData:null,originalPasswordData:null}},mounted(){this.fetchProfile()},methods:{async fetchProfile(r=!1){var e;this.loading=!0,this.error=null;try{console.log("Fetching profile... (retry:",r,")");const[n,i]=await Promise.all([f.get("/api/profile"),f.get("/api/employee/documents").catch(()=>({data:{data:[]}}))]);console.log("Profile response:",n.data),console.log("Documents response:",i.data);const o=n.data.user||n.data,t=((e=n.data.employee)==null?void 0:e.data)||n.data.employee;this.form={first_name:o.first_name||"",last_name:o.last_name||"",email:o.email||"",phone:(t==null?void 0:t.phone)||"",date_of_birth:t!=null&&t.date_of_birth?new Date(t.date_of_birth).toISOString().split("T")[0]:"",national_id:(t==null?void 0:t.national_id)||"",address:(t==null?void 0:t.address)||"",emergency_contact:(t==null?void 0:t.emergency_contact)||""},this.originalFormData={...this.form},t&&(this.employeeInfo={employee_id:t.employee_id,position:t.position,department:t.department,employment_type:t.employment_type,hire_date:t.hire_date,base_salary:t.base_salary,manager:t.manager}),this.profilePicUrl=t!=null&&t.profile_pic?`/storage/${t.profile_pic}`:"",this.documents=i.data.data||[]}catch(n){console.error("Profile fetch error:",n),this.handleApiError(n,"Failed to load profile")}finally{this.loading=!1}},async updateProfile(){this.updatingProfile=!0,this.formError=null,this.successMessage=null;try{const r={};if(Object.keys(this.form).forEach(n=>{this.form[n]!==this.originalFormData[n]&&(r[n]=this.form[n])}),Object.keys(r).length===0){this.formError="No changes detected";return}console.log("Updating profile with:",r);const e=await f.put("/api/profile",r);console.log("Update response:",e.data),this.authStore.user&&(this.authStore.user.first_name=this.form.first_name,this.authStore.user.last_name=this.form.last_name,this.authStore.user.email=this.form.email),this.originalFormData={...this.form},this.successMessage="Profile updated successfully!",this.$notify&&this.$notify({type:"success",title:"Success",text:"Profile updated successfully!"}),setTimeout(()=>{this.successMessage=null},3e3)}catch(r){console.error("Update error:",r),this.handleApiError(r,"Failed to update profile")}finally{this.updatingProfile=!1}},async updatePassword(){if(this.updatingPassword=!0,this.passwordError=null,this.passwordSuccess=null,this.passwordForm.password.length<8){this.passwordError="New password must be at least 8 characters long",this.updatingPassword=!1;return}if(this.passwordForm.password!==this.passwordForm.password_confirmation){this.passwordError="Passwords do not match",this.updatingPassword=!1;return}try{console.log("Updating password...");const r=await f.post("/api/profile/password",this.passwordForm);console.log("Password update response:",r.data),this.resetPasswordForm(),this.passwordSuccess="Password updated successfully!",this.$notify&&this.$notify({type:"success",title:"Success",text:"Password updated successfully!"}),setTimeout(()=>{this.passwordSuccess=null},3e3)}catch(r){console.error("Password update error:",r),this.handleApiError(r,"Failed to update password","password")}finally{this.updatingPassword=!1}},resetPasswordForm(){this.passwordForm={current_password:"",password:"",password_confirmation:""},this.passwordError=null,this.passwordSuccess=null},async handleProfilePicUpload(r){const e=r.target.files[0];if(!e)return;if(e.size>2*1024*1024){this.formError="Profile picture must be less than 2MB.";return}const n=new FormData;n.append("profile_pic",e);try{const i=await f.post("/api/employee/profile-pic",n,{headers:{"Content-Type":"multipart/form-data"}});this.profilePicUrl=i.data.profile_pic_url||`/storage/${i.data.profile_pic}`,this.$notify&&this.$notify({type:"success",title:"Success",text:"Profile picture updated!"})}catch(i){this.handleApiError(i,"Failed to upload profile picture")}},handleImageError(){this.profilePicUrl="/default-avatar.png"},async handleDocumentUpload(r){const e=Array.from(r.target.files);if(e.length!==0){this.uploadingDoc=!0;try{const n=new FormData;for(const o of e){if(o.size>5*1024*1024){this.formError=`File ${o.name} exceeds 5MB limit.`;continue}n.append("documents",o)}const i=await f.post("/api/employee/documents",n,{headers:{"Content-Type":"multipart/form-data"}});this.documents=[...this.documents,...i.data.newDocuments||[]],this.$notify&&this.$notify({type:"success",title:"Success",text:`${e.length} document(s) uploaded successfully!`})}catch(n){this.handleApiError(n,"Failed to upload documents")}finally{this.uploadingDoc=!1,r.target.value=""}}},async downloadDocument(r){try{const e=await f.get(`/api/employee/documents/${r}/download`,{responseType:"blob"}),n=window.URL.createObjectURL(new Blob([e.data])),i=document.createElement("a");i.href=n,i.setAttribute("download",`castle-document-${r}.pdf`),document.body.appendChild(i),i.click(),i.remove(),window.URL.revokeObjectURL(n)}catch(e){this.handleApiError(e,"Failed to download document")}},async deleteDocument(r){if(confirm("Are you sure you want to delete this document?"))try{await f.delete(`/api/employee/documents/${r}`),this.documents=this.documents.filter(e=>e.id!==r),this.$notify&&this.$notify({type:"success",title:"Success",text:"Document deleted successfully!"})}catch(e){this.handleApiError(e,"Failed to delete document")}},resetForm(){this.originalFormData?this.form={...this.originalFormData}:this.fetchProfile(),this.formError=null,this.successMessage=null},getFileIcon(r){var i;const e=(i=r.split(".").pop())==null?void 0:i.toLowerCase();return{pdf:"ğŸ“„",doc:"ğŸ“",docx:"ğŸ“",jpg:"ğŸ–¼ï¸",jpeg:"ğŸ–¼ï¸",png:"ğŸ–¼ï¸"}[e]||"ğŸ“"},retryFetch(){this.retryCount++,this.retryCount<=3?this.fetchProfile(!0):this.error="Max retries exceeded. Please refresh the page."},handleApiError(r,e="An error occurred",n="form"){var o,t,l,h,w,g;let i=e;if(r.code==="ERR_NETWORK"||(o=r.message)!=null&&o.includes("Network Error"))i="Network error. Check your connection.";else if(((t=r.response)==null?void 0:t.status)===401){i="Session expired. Redirecting to login...",this.authStore.clearAuth(),this.$router.push({name:"login"});return}else((l=r.response)==null?void 0:l.status)===403?i="Access denied.":((h=r.response)==null?void 0:h.status)===422?(i=r.response.data.message||"Please check the form for errors.",r.response.data.errors&&(i=Object.values(r.response.data.errors).flat().join(", "))):(g=(w=r.response)==null?void 0:w.data)!=null&&g.message&&(i=r.response.data.message);n==="password"?this.passwordError=i:(this.formError=i,this.error=i)},formatDate(r){return r?new Date(r).toLocaleDateString("en-ZM",{year:"numeric",month:"short",day:"numeric"}):"N/A"},formatEmploymentType(r){return r?r.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):"N/A"},getManagerName(r){return r?`${r.first_name} ${r.last_name}`:"N/A"}}},U={class:"profile-view"},x={class:"header"},C={class:"title"},k={class:"content"},S={class:"profile-pic-section"},I={class:"pic-container"},N=["src"],M={for:"profile-pic-upload",class:"pic-upload-btn"},A={class:"form-row"},V={class:"form-group"},T={class:"form-group"},R={class:"form-row"},j={class:"form-group"},L={class:"form-group"},O={class:"form-row"},B={class:"form-group"},q=["max"],z={class:"form-group"},Z={class:"form-group full-width"},G={class:"form-group full-width"},H={key:0,class:"employee-info-section"},K={class:"form-row"},W={class:"form-group"},J=["value"],Q={class:"form-group"},X=["value"],Y={class:"form-row"},$={class:"form-group"},ee=["value"],se={class:"form-group"},oe=["value"],te={class:"form-row"},re={class:"form-group"},le=["value"],ie={key:0,class:"form-group"},ne=["value"],ae={key:1,class:"form-error"},de={key:2,class:"success-message"},pe={class:"form-actions"},ue=["disabled"],me={class:"password-section"},ce={class:"form-row"},fe={class:"form-group"},he={class:"form-group"},ye={class:"form-group"},we={key:0,class:"error-small"},ge={key:0,class:"form-error"},_e={key:1,class:"success-message"},be={class:"form-actions"},ve=["disabled"],Pe={class:"documents-section"},Fe={class:"upload-area"},De={for:"document-upload",class:"upload-btn"},Ee={key:0,class:"empty-state"},Ue={key:1,class:"documents-grid"},xe={class:"doc-icon"},Ce={class:"doc-name"},ke={class:"doc-type"},Se={class:"doc-date"},Ie={class:"doc-actions"},Ne=["onClick"],Me=["onClick"],Ae={key:0,class:"loading"},Ve={key:1,class:"error-message"};function Te(r,e,n,i,o,t){return d(),a("div",U,[s("header",x,[s("h1",C,p(o.pageName),1),e[20]||(e[20]=s("p",{class:"subtitle"},"Manage your personal information and documents",-1))]),s("div",k,[s("div",S,[s("div",I,[s("img",{src:o.profilePicUrl||"/default-avatar.png",alt:"Profile Picture",class:"profile-pic",onError:e[0]||(e[0]=(...l)=>t.handleImageError&&t.handleImageError(...l))},null,40,N),s("label",M,[e[21]||(e[21]=y(" ğŸ“· Change Photo ",-1)),s("input",{id:"profile-pic-upload",type:"file",accept:"image/*",onChange:e[1]||(e[1]=(...l)=>t.handleProfilePicUpload&&t.handleProfilePicUpload(...l)),ref:"profilePicInput"},null,544)])]),e[22]||(e[22]=s("p",{class:"pic-info"},"Upload a professional photo (Max 2MB)",-1))]),s("form",{onSubmit:e[11]||(e[11]=_((...l)=>t.updateProfile&&t.updateProfile(...l),["prevent"])),class:"profile-form"},[s("div",A,[s("div",V,[e[23]||(e[23]=s("label",null,"First Name *",-1)),u(s("input",{"onUpdate:modelValue":e[2]||(e[2]=l=>o.form.first_name=l),type:"text",required:"",placeholder:"Enter first name"},null,512),[[m,o.form.first_name]])]),s("div",T,[e[24]||(e[24]=s("label",null,"Last Name *",-1)),u(s("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>o.form.last_name=l),type:"text",required:"",placeholder:"Enter last name"},null,512),[[m,o.form.last_name]])])]),s("div",R,[s("div",j,[e[25]||(e[25]=s("label",null,"Email *",-1)),u(s("input",{"onUpdate:modelValue":e[4]||(e[4]=l=>o.form.email=l),type:"email",required:"",placeholder:"employee@castleholding.co.zm"},null,512),[[m,o.form.email]])]),s("div",L,[e[26]||(e[26]=s("label",null,"Phone Number",-1)),u(s("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>o.form.phone=l),type:"tel",placeholder:"+260 97 123 4567"},null,512),[[m,o.form.phone]])])]),s("div",O,[s("div",B,[e[27]||(e[27]=s("label",null,"Date of Birth",-1)),u(s("input",{"onUpdate:modelValue":e[6]||(e[6]=l=>o.form.date_of_birth=l),type:"date",max:o.today},null,8,q),[[m,o.form.date_of_birth]])]),s("div",z,[e[28]||(e[28]=s("label",null,"National ID / Passport",-1)),u(s("input",{"onUpdate:modelValue":e[7]||(e[7]=l=>o.form.national_id=l),type:"text",placeholder:"e.g., 234567/89/1"},null,512),[[m,o.form.national_id]])])]),s("div",Z,[e[29]||(e[29]=s("label",null,"Address",-1)),u(s("textarea",{"onUpdate:modelValue":e[8]||(e[8]=l=>o.form.address=l),rows:"3",placeholder:"Enter your full address in Lusaka, Zambia..."},null,512),[[m,o.form.address]])]),s("div",G,[e[30]||(e[30]=s("label",null,"Emergency Contact",-1)),u(s("input",{"onUpdate:modelValue":e[9]||(e[9]=l=>o.form.emergency_contact=l),type:"text",placeholder:"Name and phone number"},null,512),[[m,o.form.emergency_contact]])]),o.employeeInfo?(d(),a("div",H,[e[37]||(e[37]=s("h3",{class:"section-title"},"Employment Information",-1)),s("div",K,[s("div",W,[e[31]||(e[31]=s("label",null,"Employee ID",-1)),s("input",{value:o.employeeInfo.employee_id,type:"text",readonly:""},null,8,J)]),s("div",Q,[e[32]||(e[32]=s("label",null,"Position",-1)),s("input",{value:o.employeeInfo.position,type:"text",readonly:""},null,8,X)])]),s("div",Y,[s("div",$,[e[33]||(e[33]=s("label",null,"Department",-1)),s("input",{value:o.employeeInfo.department,type:"text",readonly:""},null,8,ee)]),s("div",se,[e[34]||(e[34]=s("label",null,"Employment Type",-1)),s("input",{value:t.formatEmploymentType(o.employeeInfo.employment_type),type:"text",readonly:""},null,8,oe)])]),s("div",te,[s("div",re,[e[35]||(e[35]=s("label",null,"Hire Date",-1)),s("input",{value:t.formatDate(o.employeeInfo.hire_date),type:"text",readonly:""},null,8,le)]),o.employeeInfo.manager?(d(),a("div",ie,[e[36]||(e[36]=s("label",null,"Manager",-1)),s("input",{value:t.getManagerName(o.employeeInfo.manager),type:"text",readonly:""},null,8,ne)])):c("",!0)])])):c("",!0),o.formError?(d(),a("div",ae,p(o.formError),1)):c("",!0),o.successMessage?(d(),a("div",de,p(o.successMessage),1)):c("",!0),s("div",pe,[s("button",{type:"button",onClick:e[10]||(e[10]=(...l)=>t.resetForm&&t.resetForm(...l)),class:"btn-secondary"},"Cancel"),s("button",{type:"submit",class:"btn-primary",disabled:o.updatingProfile},p(o.updatingProfile?"Updating...":"Update Profile"),9,ue)])],32),s("div",me,[e[41]||(e[41]=s("h3",{class:"section-title"},"Change Password",-1)),e[42]||(e[42]=s("p",{class:"section-subtitle"},"Update your account password for security",-1)),s("form",{onSubmit:e[16]||(e[16]=_((...l)=>t.updatePassword&&t.updatePassword(...l),["prevent"])),class:"password-form"},[s("div",ce,[s("div",fe,[e[38]||(e[38]=s("label",null,"Current Password *",-1)),u(s("input",{"onUpdate:modelValue":e[12]||(e[12]=l=>o.passwordForm.current_password=l),type:"password",required:"",placeholder:"Enter your current password"},null,512),[[m,o.passwordForm.current_password]])]),s("div",he,[e[39]||(e[39]=s("label",null,"New Password *",-1)),u(s("input",{"onUpdate:modelValue":e[13]||(e[13]=l=>o.passwordForm.password=l),type:"password",required:"",placeholder:"Enter new password (min 8 chars)",minlength:"8"},null,512),[[m,o.passwordForm.password]])])]),s("div",ye,[e[40]||(e[40]=s("label",null,"Confirm New Password *",-1)),u(s("input",{"onUpdate:modelValue":e[14]||(e[14]=l=>o.passwordForm.password_confirmation=l),type:"password",required:"",placeholder:"Confirm new password",class:P({mismatch:o.passwordForm.password!==o.passwordForm.password_confirmation})},null,2),[[m,o.passwordForm.password_confirmation]]),o.passwordForm.password&&o.passwordForm.password_confirmation&&o.passwordForm.password!==o.passwordForm.password_confirmation?(d(),a("small",we,"Passwords do not match")):c("",!0)]),o.passwordError?(d(),a("div",ge,p(o.passwordError),1)):c("",!0),o.passwordSuccess?(d(),a("div",_e,p(o.passwordSuccess),1)):c("",!0),s("div",be,[s("button",{type:"button",onClick:e[15]||(e[15]=(...l)=>t.resetPasswordForm&&t.resetPasswordForm(...l)),class:"btn-secondary"},"Cancel"),s("button",{type:"submit",class:"btn-primary",disabled:o.updatingPassword||o.passwordForm.password!==o.passwordForm.password_confirmation},p(o.updatingPassword?"Updating...":"Update Password"),9,ve)])],32)]),s("div",Pe,[e[46]||(e[46]=s("h3",{class:"section-title"},"Official Documents",-1)),e[47]||(e[47]=s("p",{class:"section-subtitle"},"Upload and manage your employment documents",-1)),s("div",Fe,[s("label",De,[e[43]||(e[43]=y(" + Upload Document ",-1)),s("input",{id:"document-upload",type:"file",accept:".pdf,.doc,.docx,.jpg,.png",multiple:"",onChange:e[17]||(e[17]=(...l)=>t.handleDocumentUpload&&t.handleDocumentUpload(...l)),ref:"documentInput"},null,544)]),e[44]||(e[44]=s("p",{class:"upload-info"},"Supported: PDF, DOC, Images (Max 5MB each)",-1))]),o.documents.length===0?(d(),a("div",Ee,[e[45]||(e[45]=s("p",null,"No documents uploaded yet.",-1)),s("button",{onClick:e[18]||(e[18]=l=>r.$refs.documentInput.click()),class:"btn-primary"},"Upload First Document")])):(d(),a("div",Ue,[(d(!0),a(F,null,D(o.documents,l=>(d(),a("div",{key:l.id,class:"document-card"},[s("div",xe,p(t.getFileIcon(l.fileName)),1),s("h4",Ce,p(l.fileName),1),s("p",ke,p(l.type||"General Document"),1),s("p",Se,p(t.formatDate(l.uploadDate)),1),s("div",Ie,[s("button",{onClick:h=>t.downloadDocument(l.id),class:"action-btn download"},"Download",8,Ne),s("button",{onClick:h=>t.deleteDocument(l.id),class:"action-btn delete"},"Delete",8,Me)])]))),128))]))]),o.loading?(d(),a("div",Ae,[...e[48]||(e[48]=[s("div",{class:"spinner"},null,-1),s("p",null,"Loading profile...",-1)])])):c("",!0),o.error?(d(),a("div",Ve,[y(p(o.error)+" ",1),s("button",{onClick:e[19]||(e[19]=(...l)=>t.retryFetch&&t.retryFetch(...l)),class:"btn-primary"},"Retry")])):c("",!0)])])}const Oe=b(E,[["render",Te],["__scopeId","data-v-d4e5dfdb"]]);export{Oe as default};
